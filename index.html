<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExtintorCheck Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100%;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #ff6b6b;
            border-bottom: 2px solid #ff6b6b;
        }

        .tab-content {
            display: none;
            padding: 20px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .radio-option:hover {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .radio-option input[type="radio"] {
            margin: 0;
        }

        .radio-option input[type="radio"]:checked + span {
            color: #ff6b6b;
            font-weight: 600;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: inline-block;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-block {
            width: 100%;
            margin-bottom: 10px;
        }

        .extinguisher-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .extinguisher-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-weight: 600;
            color: #495057;
            margin: 0;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-excelente {
            background: #d4edda;
            color: #155724;
        }

        .status-optimo {
            background: #fff3cd;
            color: #856404;
        }

        .status-mal {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #ff6b6b;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ee5a24);
            transition: width 0.3s ease;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #ff6b6b;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .month-nav {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .current-month {
            flex: 1;
            text-align: center;
            font-weight: 600;
            color: #495057;
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üßØ ExtintorCheck Pro</h1>
            <div class="subtitle">Gesti√≥n Profesional de Extintores</div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('checklist')">üìã Check-list</button>
            <button class="nav-tab" onclick="showTab('registros')">üìÅ Registros</button>
            <button class="nav-tab" onclick="showTab('estadisticas')">üìä Estad√≠sticas</button>
            <button class="nav-tab" onclick="showTab('reportes')">üìÑ Reportes</button>
        </nav>

        <!-- Tab: Check-list -->
        <div id="checklist" class="tab-content active">

            <form id="extinguisherForm">
                <div class="form-group">
                    <label for="ubicacion">üìç Ubicaci√≥n</label>
                    <input type="text" id="ubicacion" class="form-control" placeholder="Ej: Planta baja - Pasillo A" required>
                </div>

                <div class="form-group">
                    <label>üî• Tipo de Extintor</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="tipo" value="CO2" required>
                            <span>CO2</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="tipo" value="PQS" required>
                            <span>PQS</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="capacidad">‚öñÔ∏è Capacidad (kg)</label>
                    <select id="capacidad" class="form-control" required>
                        <option value="">Seleccionar capacidad</option>
                        <option value="2">2 kg</option>
                        <option value="4">4 kg</option>
                        <option value="4.5">4.5 kg</option>
                        <option value="6">6 kg</option>
                        <option value="9">9 kg</option>
                        <option value="12">12 kg</option>
                        <option value="50">50 kg</option>
                        <option value="70">70 kg</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="senalizacion" name="senalizacion">
                        <label for="senalizacion">üö® Cuenta con se√±alizaci√≥n</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>üîß Estado del Man√≥metro</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="manometro" value="baja_presion" required>
                            <span>Baja Presi√≥n</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="manometro" value="presion_optima" required>
                            <span>Presi√≥n √ìptima</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="manometro" value="sobre_presion" required>
                            <span>Sobre Presi√≥n</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>üîó Estado de las Mangueras</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="mangueras" value="mal_estado" required>
                            <span>Mal Estado</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="mangueras" value="optimo" required>
                            <span>√ìptimo</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="mangueras" value="excelente" required>
                            <span>Excelente</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="seguros" name="seguros">
                        <label for="seguros">üîí Cuenta con seguros y cincho</label>
                    </div>
                </div>

                <div class="form-group" id="selloSeguridadGroup" style="display: none;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="selloSeguridad" name="selloSeguridad">
                        <label for="selloSeguridad">üè∑Ô∏è Cuenta con sello de seguridad (Solo PQS)</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>üí® Estado del Difusor</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="difusor" value="mal_estado" required>
                            <span>Mal Estado</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difusor" value="optimo" required>
                            <span>√ìptimo</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difusor" value="excelente" required>
                            <span>Excelente</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="caducidad">üìÖ Fecha de Caducidad</label>
                    <input type="date" id="caducidad" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>üè• Estado F√≠sico General</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="estado_fisico" value="mal_estado" required>
                            <span>Mal Estado</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="estado_fisico" value="optimo" required>
                            <span>√ìptimo</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="estado_fisico" value="excelente" required>
                            <span>Excelente</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">üíæ Guardar Registro</button>
            </form>
        </div>

        <!-- Tab: Registros -->
        <div id="registros" class="tab-content">
            <div class="month-selector">
                <button class="month-nav" onclick="changeRegistrosMonth(-1)">‚Äπ</button>
                <div class="current-month" id="registrosMonth"></div>
                <button class="month-nav" onclick="changeRegistrosMonth(1)">‚Ä∫</button>
            </div>
            
            <div id="registrosList"></div>
        </div>

        <!-- Tab: Estad√≠sticas -->
        <div id="estadisticas" class="tab-content">
            <div class="month-selector">
                <button class="month-nav" onclick="changeStatsMonth(-1)">‚Äπ</button>
                <div class="current-month" id="statsMonth"></div>
                <button class="month-nav" onclick="changeStatsMonth(1)">‚Ä∫</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalExtintores">0</div>
                    <div class="stat-label">Total Extintores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="extintoresExcelentes">0</div>
                    <div class="stat-label">Excelente Estado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="extintoresOptimos">0</div>
                    <div class="stat-label">Estado √ìptimo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="extintoresMalos">0</div>
                    <div class="stat-label">Mal Estado</div>
                </div>
            </div>

            <div class="stat-card">
                <h3 style="margin-top: 0; color: #495057;">üìä Distribuci√≥n por Tipo</h3>
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>CO2</span>
                        <span id="co2Percentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="co2Progress" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>PQS</span>
                        <span id="pqsPercentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="pqsProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3 style="margin-top: 0; color: #495057;">‚ö†Ô∏è Alertas del Mes</h3>
                <div id="alertsList"></div>
            </div>
        </div>

        <!-- Tab: Reportes -->
        <div id="reportes" class="tab-content">
            <div class="month-selector">
                <button class="month-nav" onclick="changeReportMonth(-1)">‚Äπ</button>
                <div class="current-month" id="reportMonth"></div>
                <button class="month-nav" onclick="changeReportMonth(1)">‚Ä∫</button>
            </div>

            <div class="stat-card" style="margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #495057;">üìÑ Generar Reporte Mensual</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">
                    Exporta todos los registros del mes seleccionado en formato PDF para presentar a la administraci√≥n.
                </p>
                <button onclick="generatePDF()" class="btn btn-success btn-block">
                    üì• Descargar Reporte PDF
                </button>
            </div>

            <div class="stat-card">
                <h3 style="margin-top: 0; color: #495057;">üîÑ Gesti√≥n Mensual</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">
                    Herramientas para gestionar el ciclo mensual de inspecciones.
                </p>
                <button onclick="resetMonthlyData()" class="btn" style="background: #17a2b8; color: white; margin-bottom: 10px;" class="btn-block">
                    üîÑ Reiniciar Mes Actual
                </button>
                <button onclick="archiveCurrentMonth()" class="btn" style="background: #6f42c1; color: white;" class="btn-block">
                    üì¶ Archivar Mes Actual
                </button>
            </div>

            <div class="stat-card">
                <h3 style="margin-top: 0; color: #495057;">üíæ Gesti√≥n de Datos</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">
                    Todos los datos se almacenan localmente en tu dispositivo para garantizar la privacidad y disponibilidad offline.
                </p>
                <button onclick="exportData()" class="btn btn-secondary btn-block">
                    üì§ Exportar Datos JSON
                </button>
                <button onclick="clearAllData()" class="btn" style="background: #dc3545; color: white; margin-top: 10px;" onclick="return confirm('¬øEst√°s seguro de eliminar todos los datos?')">
                    üóëÔ∏è Limpiar Todos los Datos
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentDate = new Date();
        let registrosDate = new Date();
        let statsDate = new Date();
        let reportDate = new Date();

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            updateMonthDisplays();
            loadRegistros();
            updateStats();
            
            // Configurar formulario
            document.getElementById('extinguisherForm').addEventListener('submit', handleFormSubmit);
            
            // Configurar eventos para mostrar/ocultar sello de seguridad
            document.querySelectorAll('input[name="tipo"]').forEach(radio => {
                radio.addEventListener('change', toggleSelloSeguridad);
            });
            
            // Verificar y cargar autom√°ticamente registros del mes actual
            autoLoadCurrentMonthRegistros();
        });

        // Funci√≥n para mostrar/ocultar sello de seguridad
        function toggleSelloSeguridad() {
            const tipoSeleccionado = document.querySelector('input[name="tipo"]:checked');
            const selloGroup = document.getElementById('selloSeguridadGroup');
            const selloCheckbox = document.getElementById('selloSeguridad');
            
            if (tipoSeleccionado && tipoSeleccionado.value === 'PQS') {
                selloGroup.style.display = 'block';
            } else {
                selloGroup.style.display = 'none';
                selloCheckbox.checked = false; // Limpiar si no es PQS
            }
        }

        // Gesti√≥n de pesta√±as
        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Actualizar contenido seg√∫n la pesta√±a
            if (tabName === 'registros') {
                loadRegistros();
            } else if (tabName === 'estadisticas') {
                updateStats();
            }
        }

        // Gesti√≥n de fechas
        function updateMonthDisplays() {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            document.getElementById('registrosMonth').textContent = 
                `${months[registrosDate.getMonth()]} ${registrosDate.getFullYear()}`;
            document.getElementById('statsMonth').textContent = 
                `${months[statsDate.getMonth()]} ${statsDate.getFullYear()}`;
            document.getElementById('reportMonth').textContent = 
                `${months[reportDate.getMonth()]} ${reportDate.getFullYear()}`;
        }



        function changeRegistrosMonth(direction) {
            registrosDate.setMonth(registrosDate.getMonth() + direction);
            updateMonthDisplays();
            loadRegistros();
        }

        function changeStatsMonth(direction) {
            statsDate.setMonth(statsDate.getMonth() + direction);
            updateMonthDisplays();
            updateStats();
        }

        function changeReportMonth(direction) {
            reportDate.setMonth(reportDate.getMonth() + direction);
            updateMonthDisplays();
        }

        // Manejo del formulario
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            const editingId = form.dataset.editingId;
            
            // Validar que todos los campos requeridos est√©n completos
            const tipoSeleccionado = formData.get('tipo');
            const manometroSeleccionado = formData.get('manometro');
            const manguerasSeleccionado = formData.get('mangueras');
            const difusorSeleccionado = formData.get('difusor');
            const estadoFisicoSeleccionado = formData.get('estado_fisico');
            
            if (!tipoSeleccionado || !manometroSeleccionado || !manguerasSeleccionado || 
                !difusorSeleccionado || !estadoFisicoSeleccionado) {
                showAlert('‚ö†Ô∏è Por favor completa todos los campos requeridos', 'warning');
                return;
            }
            
            const registro = {
                id: editingId ? parseInt(editingId) : Date.now(),
                ubicacion: document.getElementById('ubicacion').value.trim() || '',
                tipo: tipoSeleccionado,
                capacidad: document.getElementById('capacidad').value,
                senalizacion: document.getElementById('senalizacion').checked,
                manometro: manometroSeleccionado,
                mangueras: manguerasSeleccionado,
                seguros: document.getElementById('seguros').checked,
                selloSeguridad: document.getElementById('selloSeguridad').checked,
                difusor: difusorSeleccionado,
                caducidad: document.getElementById('caducidad').value || '',
                estado_fisico: estadoFisicoSeleccionado
            };
            
            // Solo asignar mes y a√±o para NUEVOS registros, NO para ediciones
            if (!editingId) {
                const today = new Date();
                registro.mes = today.getMonth();
                registro.a√±o = today.getFullYear();
                registro.fecha = new Date().toISOString();
            }
            
            if (editingId) {
                // Actualizar registro existente
                const success = updateRegistro(registro);
                if (success) {
                    showAlert('‚úÖ Registro actualizado exitosamente', 'success');
                    // Salir del modo edici√≥n
                    cancelEdit();
                } else {
                    showAlert('‚ùå Error al actualizar el registro', 'warning');
                }
            } else {
                // Guardar nuevo registro (fecha ya asignada arriba)
                const guardadoExitoso = saveRegistro(registro);
                
                if (guardadoExitoso) {
                    showAlert('‚úÖ Registro guardado exitosamente', 'success');
                    
                    // Limpiar formulario
                    form.reset();
                    // Ocultar sello de seguridad al limpiar
                    document.getElementById('selloSeguridadGroup').style.display = 'none';
                } else {
                    showAlert('‚ùå Error al guardar el registro', 'warning');
                    return; // No limpiar el formulario si hubo error
                }
            }
            
            // Actualizar estad√≠sticas
            updateStats();
        }

        function saveRegistro(registro) {
            console.log('üíæ Guardando registro:', registro);
            
            // Validar que el registro tenga los campos requeridos
            if (!registro.ubicacion || !registro.tipo || typeof registro.mes !== 'number' || typeof registro.a√±o !== 'number') {
                console.error('‚ùå Registro inv√°lido:', registro);
                showAlert('‚ùå Error: Registro con datos incompletos', 'warning');
                return false;
            }
            
            try {
                let registros = JSON.parse(localStorage.getItem('extintorRegistros') || '[]');
                console.log('üíæ Registros existentes:', registros.length);
                
                // Asegurar que el registro tenga un ID √∫nico
                if (!registro.id) {
                    registro.id = Date.now() + Math.floor(Math.random() * 10000);
                }
                
                // Verificar que no exista un registro con el mismo ID
                const existeId = registros.some(r => r.id === registro.id);
                if (existeId) {
                    registro.id = Date.now() + Math.floor(Math.random() * 10000);
                    console.log('üíæ ID duplicado detectado, generando nuevo ID:', registro.id);
                }
                
                registros.push(registro);
                localStorage.setItem('extintorRegistros', JSON.stringify(registros));
                
                // Verificar que se guard√≥ correctamente
                const verificacion = JSON.parse(localStorage.getItem('extintorRegistros') || '[]');
                const registroGuardado = verificacion.find(r => r.id === registro.id);
                
                if (!registroGuardado) {
                    throw new Error('El registro no se guard√≥ correctamente');
                }
                
                console.log('‚úÖ Registro guardado exitosamente:', {
                    id: registro.id,
                    ubicacion: registro.ubicacion,
                    mes: registro.mes,
                    a√±o: registro.a√±o
                });
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error al guardar registro:', error);
                showAlert('‚ùå Error al guardar el registro', 'warning');
                return false;
            }
        }

        function updateRegistro(registroActualizado) {
            let registros = getRegistros();
            const index = registros.findIndex(r => r.id == registroActualizado.id);
            
            if (index !== -1) {
                const registroOriginal = registros[index];
                
                // MANTENER el mes y a√±o del registro original para evitar duplicaciones
                // Solo actualizar los datos del extintor, NO la ubicaci√≥n temporal
                registros[index] = {
                    ...registros[index], // Mantener campos existentes
                    ...registroActualizado, // Sobrescribir con nuevos valores
                    id: registros[index].id, // Mantener ID original
                    fecha: registros[index].fecha, // Mantener fecha de creaci√≥n original
                    mes: registros[index].mes, // MANTENER mes original (CR√çTICO)
                    a√±o: registros[index].a√±o, // MANTENER a√±o original (CR√çTICO)
                    fechaActualizacion: new Date().toISOString() // Actualizar fecha de modificaci√≥n
                };
                
                console.log('‚úèÔ∏è Registro actualizado correctamente:', {
                    id: registros[index].id,
                    ubicacion: registros[index].ubicacion,
                    mesOriginal: registroOriginal.mes,
                    a√±oOriginal: registroOriginal.a√±o,
                    mesMantenido: registros[index].mes,
                    a√±oMantenido: registros[index].a√±o
                });
                
                localStorage.setItem('extintorRegistros', JSON.stringify(registros));
                loadRegistros(); // Recargar la lista
                return true;
            }
            return false;
        }

        function getRegistros() {
            return JSON.parse(localStorage.getItem('extintorRegistros') || '[]');
        }

        function getRegistrosByMonth(mes, a√±o) {
            const registros = getRegistros();
            return registros.filter(r => r.mes === mes && r.a√±o === a√±o);
        }

        // Cargar y mostrar registros
        function loadRegistros() {
            const registros = getRegistrosByMonth(registrosDate.getMonth(), registrosDate.getFullYear());
            const container = document.getElementById('registrosList');
            
            if (registros.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No hay registros</h3>
                        <p>No se encontraron registros para este mes.</p>
                        <button onclick="copyPreviousMonthRegistros()" class="btn btn-primary" style="margin-top: 15px;">
                            üîÑ Actualizar desde Mes Anterior
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = registros.map(registro => `
                <div class="extinguisher-card">
                    <div class="card-header">
                        <h4 class="card-title">üìç ${registro.ubicacion}</h4>
                        <span class="status-badge status-${registro.estado_fisico.replace('_', '-')}">
                            ${registro.estado_fisico.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                        <div><strong>Tipo:</strong> ${registro.tipo}</div>
                        <div><strong>Capacidad:</strong> ${registro.capacidad} kg</div>
                        <div><strong>Man√≥metro:</strong> ${registro.manometro.replace('_', ' ')}</div>
                        <div><strong>Mangueras:</strong> ${registro.mangueras}</div>
                        <div><strong>Difusor:</strong> ${registro.difusor}</div>
                        <div><strong>Se√±alizaci√≥n:</strong> ${registro.senalizacion ? '‚úÖ' : '‚ùå'}</div>
                        <div><strong>Seguros:</strong> ${registro.seguros ? '‚úÖ' : '‚ùå'}</div>
                        ${registro.tipo === 'PQS' ? `<div><strong>Sello Seguridad:</strong> ${registro.selloSeguridad ? '‚úÖ' : '‚ùå'}</div>` : ''}
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef; font-size: 12px; color: #6c757d;">
                        <strong>Caducidad:</strong> ${registro.caducidad ? new Date(registro.caducidad + 'T00:00:00').toLocaleDateString('es-ES') : 'No especificada'} | 
                        <strong>Registrado:</strong> ${new Date(registro.fecha).toLocaleDateString('es-ES')}
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button onclick="editRegistro(${registro.id})" class="btn btn-secondary" style="flex: 1; padding: 6px 12px; font-size: 12px;">
                            ‚úèÔ∏è Editar
                        </button>
                        <button onclick="deleteRegistro(${registro.id})" class="btn" style="background: #dc3545; color: white; flex: 1; padding: 6px 12px; font-size: 12px;">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteRegistro(id) {
            if (confirm('¬øEst√°s seguro de eliminar este registro?')) {
                let registros = getRegistros();
                registros = registros.filter(r => r.id != id);
                localStorage.setItem('extintorRegistros', JSON.stringify(registros));
                loadRegistros();
                updateStats();
                showAlert('üóëÔ∏è Registro eliminado', 'warning');
            }
        }

        function editRegistro(id) {
            const registros = getRegistros();
            const registro = registros.find(r => r.id === id);
            
            if (!registro) {
                showAlert('‚ùå Registro no encontrado', 'warning');
                return;
            }
            
            // Cambiar a la pesta√±a de check-list
            showTab('checklist');
            document.querySelector('[onclick="showTab(\'checklist\')"]').classList.add('active');
            
            // Esperar un momento para que la pesta√±a se active completamente
            setTimeout(() => {
                // Llenar el formulario con los datos del registro
                document.getElementById('ubicacion').value = registro.ubicacion || '';
                
                // Seleccionar tipo de extintor
                const tipoRadio = document.querySelector(`input[name="tipo"][value="${registro.tipo}"]`);
                if (tipoRadio) tipoRadio.checked = true;
                
                document.getElementById('capacidad').value = registro.capacidad || '';
                document.getElementById('senalizacion').checked = registro.senalizacion || false;
                
                // Seleccionar estado del man√≥metro
                const manometroRadio = document.querySelector(`input[name="manometro"][value="${registro.manometro}"]`);
                if (manometroRadio) manometroRadio.checked = true;
                
                // Seleccionar estado de mangueras
                const manguerasRadio = document.querySelector(`input[name="mangueras"][value="${registro.mangueras}"]`);
                if (manguerasRadio) manguerasRadio.checked = true;
                
                document.getElementById('seguros').checked = registro.seguros || false;
                document.getElementById('selloSeguridad').checked = registro.selloSeguridad || false;
                
                // Mostrar/ocultar sello de seguridad seg√∫n el tipo
                toggleSelloSeguridad();
                
                // Seleccionar estado del difusor
                const difusorRadio = document.querySelector(`input[name="difusor"][value="${registro.difusor}"]`);
                if (difusorRadio) difusorRadio.checked = true;
                
                document.getElementById('caducidad').value = registro.caducidad || '';
                
                // Seleccionar estado f√≠sico
                const estadoRadio = document.querySelector(`input[name="estado_fisico"][value="${registro.estado_fisico}"]`);
                if (estadoRadio) estadoRadio.checked = true;
            }, 100);
            
            // Cambiar el comportamiento del formulario para edici√≥n
            const form = document.getElementById('extinguisherForm');
            form.dataset.editingId = id;
            
            // Cambiar el texto del bot√≥n
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = '‚úèÔ∏è Actualizar Registro';
            submitBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
            
            // Agregar bot√≥n de cancelar
            if (!document.getElementById('cancelEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.id = 'cancelEditBtn';
                cancelBtn.className = 'btn btn-secondary btn-block';
                cancelBtn.textContent = '‚ùå Cancelar Edici√≥n';
                cancelBtn.onclick = cancelEdit;
                form.appendChild(cancelBtn);
            }
            
            showAlert('‚úèÔ∏è Modo edici√≥n activado', 'success');
        }

        function cancelEdit() {
            const form = document.getElementById('extinguisherForm');
            delete form.dataset.editingId;
            
            // Restaurar bot√≥n original
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'üíæ Guardar Registro';
            submitBtn.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a24)';
            
            // Remover bot√≥n de cancelar
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
            
            // Limpiar formulario
            form.reset();
            
            // Ocultar sello de seguridad al cancelar
            document.getElementById('selloSeguridadGroup').style.display = 'none';
            document.getElementById('selloSeguridad').checked = false;
            
            showAlert('‚ùå Edici√≥n cancelada', 'warning');
        }

        function autoLoadCurrentMonthRegistros() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            console.log('üîç Verificando registros para mes actual:', getMonthName(currentMonth), currentYear);
            
            // Verificar si ya existen registros en el mes actual
            const existingRegistros = getRegistrosByMonth(currentMonth, currentYear);
            
            if (existingRegistros.length === 0) {
                console.log('üìÖ No hay registros en el mes actual, buscando mes anterior...');
                
                // Buscar registros del mes anterior
                let previousMonth = currentMonth - 1;
                let previousYear = currentYear;
                
                if (previousMonth < 0) {
                    previousMonth = 11;
                    previousYear = currentYear - 1;
                }
                
                const previousRegistros = getRegistrosByMonth(previousMonth, previousYear);
                
                if (previousRegistros.length > 0) {
                    console.log(`üîÑ Encontrados ${previousRegistros.length} registros en ${getMonthName(previousMonth)} ${previousYear}`);
                    
                    // Cargar autom√°ticamente sin confirmaci√≥n
                    updateRegistrosToCurrentMonth(
                        previousRegistros, 
                        currentMonth, 
                        currentYear, 
                        `${getMonthName(previousMonth)} ${previousYear}`,
                        true // Modo silencioso
                    );
                } else {
                    console.log('‚ö†Ô∏è No se encontraron registros del mes anterior');
                }
            } else {
                console.log(`‚úÖ Ya existen ${existingRegistros.length} registros en el mes actual`);
            }
        }

        function copyPreviousMonthRegistros() {
            // Usar el mes que se est√° visualizando actualmente en la pesta√±a de registros
            const targetMonth = registrosDate.getMonth();
            const targetYear = registrosDate.getFullYear();
            
            console.log('üîç Actualizando registros para mes visualizado:', getMonthName(targetMonth), targetYear);
            
            // Verificar si ya existen registros en el mes que se est√° visualizando
            const existingRegistros = getRegistrosByMonth(targetMonth, targetYear);
            if (existingRegistros.length > 0) {
                if (!confirm(`Ya existen ${existingRegistros.length} registros en ${getMonthName(targetMonth)} ${targetYear}. ¬øDeseas reemplazarlos con los datos del mes anterior?`)) {
                    return;
                }
                // Si ya existen, actualizar los existentes
                updateExistingRegistrosFromPrevious(targetMonth, targetYear);
                return;
            }
            
            // Buscar registros del mes anterior al mes que se est√° visualizando
            let previousMonth = targetMonth - 1;
            let previousYear = targetYear;
            
            if (previousMonth < 0) {
                previousMonth = 11;
                previousYear = targetYear - 1;
            }
            
            console.log('üîç Buscando en mes anterior:', getMonthName(previousMonth), previousYear);
            
            const previousRegistros = getRegistrosByMonth(previousMonth, previousYear);
            
            if (previousRegistros.length === 0) {
                // Buscar en meses anteriores hasta encontrar registros
                let searchMonth = previousMonth;
                let searchYear = previousYear;
                let foundRegistros = [];
                let monthsSearched = 0;
                
                while (foundRegistros.length === 0 && monthsSearched < 12) {
                    searchMonth--;
                    monthsSearched++;
                    
                    if (searchMonth < 0) {
                        searchMonth = 11;
                        searchYear--;
                    }
                    
                    foundRegistros = getRegistrosByMonth(searchMonth, searchYear);
                    console.log(`üîç Buscando en ${getMonthName(searchMonth)} ${searchYear}: ${foundRegistros.length} registros`);
                }
                
                if (foundRegistros.length === 0) {
                    showAlert('‚ö†Ô∏è No se encontraron registros en los √∫ltimos 12 meses para actualizar', 'warning');
                    return;
                }
                
                const monthName = getMonthName(searchMonth);
                if (!confirm(`No hay registros del mes anterior. ¬øCopiar ${foundRegistros.length} extintores de ${monthName} ${searchYear} a ${getMonthName(targetMonth)} ${targetYear}?`)) {
                    return;
                }
                
                // Usar los registros encontrados
                updateRegistrosToCurrentMonth(foundRegistros, targetMonth, targetYear, `${monthName} ${searchYear}`);
                return;
            }
            
            const previousMonthName = getMonthName(previousMonth);
            if (!confirm(`¬øCopiar ${previousRegistros.length} extintores desde ${previousMonthName} ${previousYear} a ${getMonthName(targetMonth)} ${targetYear}? Esto copiar√° todos los datos del mes anterior.`)) {
                return;
            }
            
            // Copiar al mes que se est√° visualizando
            updateRegistrosToCurrentMonth(previousRegistros, targetMonth, targetYear, `${previousMonthName} ${previousYear}`);
        }

        function updateRegistrosToCurrentMonth(sourceRegistros, targetMonth, targetYear, sourceName, silentMode = false) {
            console.log('üîÑ Iniciando actualizaci√≥n de registros...');
            console.log('üîÑ Registros origen:', sourceRegistros.length);
            console.log('üîÑ Mes destino:', getMonthName(targetMonth), targetYear);
            
            // Validar que los registros origen sean v√°lidos
            if (!sourceRegistros || sourceRegistros.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros v√°lidos para actualizar', 'warning');
                return;
            }
            
            // Crear nuevos registros basados en los anteriores (COPIANDO TODOS LOS DATOS)
            const timestamp = Date.now();
            const nuevosRegistros = sourceRegistros.map((registro, index) => {
                // Validar que el registro origen tenga los campos m√≠nimos
                if (!registro.ubicacion || !registro.tipo) {
                    console.warn('‚ö†Ô∏è Registro origen incompleto:', registro);
                    return null;
                }
                
                // Crear un nuevo registro COPIANDO TODOS LOS DATOS del mes anterior
                const nuevoRegistro = {
                    id: timestamp + index + Math.floor(Math.random() * 10000), // ID √∫nico m√°s robusto
                    fecha: new Date().toISOString(),
                    mes: parseInt(targetMonth), // Asegurar que sea n√∫mero
                    a√±o: parseInt(targetYear), // Asegurar que sea n√∫mero
                    
                    // COPIAR TODOS LOS DATOS DEL REGISTRO ANTERIOR
                    ubicacion: String(registro.ubicacion).trim(),
                    tipo: registro.tipo || 'CO2',
                    capacidad: registro.capacidad || '6',
                    caducidad: registro.caducidad || '',
                    senalizacion: registro.senalizacion || false,
                    manometro: registro.manometro || 'presion_optima',
                    mangueras: registro.mangueras || 'optimo',
                    seguros: registro.seguros || false,
                    selloSeguridad: registro.selloSeguridad || false,
                    difusor: registro.difusor || 'optimo',
                    estado_fisico: registro.estado_fisico || 'optimo',
                    
                    // Metadatos
                    actualizadoDe: sourceName,
                    fechaActualizacion: new Date().toISOString(),
                    copiaDe: `${getMonthName(registro.mes)} ${registro.a√±o}` // Referencia al mes original
                };
                
                console.log('üîÑ Registro copiado completo:', {
                    id: nuevoRegistro.id,
                    ubicacion: nuevoRegistro.ubicacion,
                    mes: nuevoRegistro.mes,
                    a√±o: nuevoRegistro.a√±o,
                    estado_fisico: nuevoRegistro.estado_fisico,
                    manometro: nuevoRegistro.manometro
                });
                
                return nuevoRegistro;
            }).filter(registro => registro !== null); // Filtrar registros nulos
            
            if (nuevosRegistros.length === 0) {
                showAlert('‚ö†Ô∏è No se pudieron crear registros v√°lidos', 'warning');
                return;
            }
            
            // Obtener registros existentes
            let todosLosRegistros = getRegistros();
            console.log('üîÑ Registros existentes antes de actualizaci√≥n:', todosLosRegistros.length);
            
            // Verificar que no haya duplicados por ubicaci√≥n en el mismo mes
            const registrosExistentesDelMes = todosLosRegistros.filter(r => 
                parseInt(r.mes) === parseInt(targetMonth) && parseInt(r.a√±o) === parseInt(targetYear)
            );
            
            console.log('üîÑ Registros existentes en mes destino:', registrosExistentesDelMes.length);
            
            const nuevosRegistrosFiltrados = nuevosRegistros.filter(nuevo => {
                const yaExiste = registrosExistentesDelMes.some(existente => 
                    String(existente.ubicacion).toLowerCase().trim() === String(nuevo.ubicacion).toLowerCase().trim()
                );
                if (yaExiste) {
                    console.log('üîÑ Duplicado omitido:', nuevo.ubicacion);
                }
                return !yaExiste;
            });
            
            if (nuevosRegistrosFiltrados.length === 0) {
                showAlert('‚ö†Ô∏è Todos los extintores ya existen en este mes', 'warning');
                return;
            }
            
            if (nuevosRegistrosFiltrados.length < nuevosRegistros.length && !silentMode) {
                const duplicados = nuevosRegistros.length - nuevosRegistrosFiltrados.length;
                if (!confirm(`Se encontraron ${duplicados} extintores duplicados que ser√°n omitidos. ¬øContinuar actualizando ${nuevosRegistrosFiltrados.length} extintores?`)) {
                    return;
                }
            }
            
            // Agregar los nuevos registros
            todosLosRegistros = todosLosRegistros.concat(nuevosRegistrosFiltrados);
            console.log('üîÑ Total registros despu√©s de actualizaci√≥n:', todosLosRegistros.length);
            
            // Validar antes de guardar
            const registrosValidos = todosLosRegistros.filter(r => 
                r && r.id && r.ubicacion && r.tipo && 
                typeof r.mes === 'number' && typeof r.a√±o === 'number'
            );
            
            if (registrosValidos.length !== todosLosRegistros.length) {
                console.error('‚ö†Ô∏è Se encontraron registros inv√°lidos, limpiando...');
                todosLosRegistros = registrosValidos;
            }
            
            // Guardar en localStorage con validaci√≥n
            try {
                localStorage.setItem('extintorRegistros', JSON.stringify(todosLosRegistros));
                console.log('‚úÖ Registros guardados exitosamente');
                
                // Verificar que se guard√≥ correctamente
                const verificacion = JSON.parse(localStorage.getItem('extintorRegistros') || '[]');
                if (verificacion.length !== todosLosRegistros.length) {
                    throw new Error('Error en la verificaci√≥n del guardado');
                }
                
            } catch (error) {
                console.error('‚ùå Error al guardar registros:', error);
                showAlert('‚ùå Error al guardar los registros actualizados', 'warning');
                return;
            }
            
            // Actualizar la interfaz inmediatamente
            loadRegistros();
            updateStats();
            
            if (!silentMode) {
                showAlert(`‚úÖ ${nuevosRegistrosFiltrados.length} extintores copiados completamente desde ${sourceName} a ${getMonthName(targetMonth)} ${targetYear}. Ahora solo edita los que necesites actualizar.`, 'success');
            } else {
                console.log(`‚úÖ Carga autom√°tica: ${nuevosRegistrosFiltrados.length} extintores copiados desde ${sourceName} a ${getMonthName(targetMonth)} ${targetYear}`);
            }
            
            // Mostrar detalles de lo que se actualiz√≥
            console.log('‚úÖ Extintores actualizados exitosamente:', nuevosRegistrosFiltrados.map(r => ({
                id: r.id,
                ubicacion: r.ubicacion,
                tipo: r.tipo,
                capacidad: r.capacidad,
                mes: r.mes,
                a√±o: r.a√±o
            })));
        }

        function updateExistingRegistrosFromPrevious(targetMonth, targetYear) {
            console.log('üîÑ Actualizando registros existentes...');
            
            // Buscar registros del mes anterior al mes objetivo
            let previousMonth = targetMonth - 1;
            let previousYear = targetYear;
            
            if (previousMonth < 0) {
                previousMonth = 11;
                previousYear = targetYear - 1;
            }
            
            const previousRegistros = getRegistrosByMonth(previousMonth, previousYear);
            
            if (previousRegistros.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros del mes anterior para actualizar', 'warning');
                return;
            }
            
            let todosLosRegistros = getRegistros();
            let registrosActualizados = 0;
            let registrosNuevos = 0;
            
            // Actualizar registros existentes y agregar nuevos
            previousRegistros.forEach(prevRegistro => {
                if (!prevRegistro.ubicacion || !prevRegistro.tipo) return;
                
                // Buscar si existe un registro con la misma ubicaci√≥n en el mes objetivo
                const existingIndex = todosLosRegistros.findIndex(r => 
                    parseInt(r.mes) === parseInt(targetMonth) && 
                    parseInt(r.a√±o) === parseInt(targetYear) &&
                    String(r.ubicacion).toLowerCase().trim() === String(prevRegistro.ubicacion).toLowerCase().trim()
                );
                
                if (existingIndex !== -1) {
                    // SOBRESCRIBIR COMPLETAMENTE el registro existente con TODOS los datos del mes anterior
                    const registroExistente = todosLosRegistros[existingIndex];
                    todosLosRegistros[existingIndex] = {
                        // Mantener solo ID y fecha de creaci√≥n original
                        id: registroExistente.id,
                        fecha: registroExistente.fecha,
                        mes: parseInt(targetMonth),
                        a√±o: parseInt(targetYear),
                        
                        // COPIAR TODOS LOS DATOS DEL MES ANTERIOR
                        ubicacion: String(prevRegistro.ubicacion).trim(),
                        tipo: prevRegistro.tipo,
                        capacidad: prevRegistro.capacidad,
                        caducidad: prevRegistro.caducidad,
                        senalizacion: prevRegistro.senalizacion || false,
                        manometro: prevRegistro.manometro || 'presion_optima',
                        mangueras: prevRegistro.mangueras || 'optimo',
                        seguros: prevRegistro.seguros || false,
                        selloSeguridad: prevRegistro.selloSeguridad || false,
                        difusor: prevRegistro.difusor || 'optimo',
                        estado_fisico: prevRegistro.estado_fisico || 'optimo',
                        
                        // Metadatos
                        actualizadoDe: `${getMonthName(previousMonth)} ${previousYear}`,
                        fechaActualizacionCompleta: new Date().toISOString(),
                        copiaDe: `${getMonthName(previousMonth)} ${previousYear}`
                    };
                    registrosActualizados++;
                    console.log('üîÑ Registro completamente actualizado:', prevRegistro.ubicacion);
                } else {
                    // Crear nuevo registro COPIANDO TODOS LOS DATOS del anterior
                    const nuevoRegistro = {
                        id: Date.now() + Math.floor(Math.random() * 10000),
                        fecha: new Date().toISOString(),
                        mes: parseInt(targetMonth),
                        a√±o: parseInt(targetYear),
                        
                        // COPIAR TODOS LOS DATOS DEL REGISTRO ANTERIOR
                        ubicacion: String(prevRegistro.ubicacion).trim(),
                        tipo: prevRegistro.tipo,
                        capacidad: prevRegistro.capacidad,
                        caducidad: prevRegistro.caducidad,
                        senalizacion: prevRegistro.senalizacion || false,
                        manometro: prevRegistro.manometro || 'presion_optima',
                        mangueras: prevRegistro.mangueras || 'optimo',
                        seguros: prevRegistro.seguros || false,
                        selloSeguridad: prevRegistro.selloSeguridad || false,
                        difusor: prevRegistro.difusor || 'optimo',
                        estado_fisico: prevRegistro.estado_fisico || 'optimo',
                        
                        // Metadatos
                        actualizadoDe: `${getMonthName(previousMonth)} ${previousYear}`,
                        fechaActualizacion: new Date().toISOString(),
                        copiaDe: `${getMonthName(previousMonth)} ${previousYear}`
                    };
                    
                    todosLosRegistros.push(nuevoRegistro);
                    registrosNuevos++;
                    console.log('üîÑ Nuevo registro copiado completo:', prevRegistro.ubicacion);
                }
            });
            
            // Guardar cambios
            try {
                localStorage.setItem('extintorRegistros', JSON.stringify(todosLosRegistros));
                
                // Actualizar interfaz inmediatamente
                loadRegistros();
                updateStats();
                
                let mensaje = '‚úÖ Registros copiados completamente: ';
                if (registrosActualizados > 0) mensaje += `${registrosActualizados} actualizados con todos los datos`;
                if (registrosNuevos > 0) {
                    if (registrosActualizados > 0) mensaje += ', ';
                    mensaje += `${registrosNuevos} nuevos copiados`;
                }
                mensaje += '. Ahora solo edita los registros que necesites actualizar.';
                
                showAlert(mensaje, 'success');
                
            } catch (error) {
                console.error('‚ùå Error al guardar actualizaciones:', error);
                showAlert('‚ùå Error al guardar las actualizaciones', 'warning');
            }
        }

        // Estad√≠sticas
        function updateStats() {
            const registros = getRegistrosByMonth(statsDate.getMonth(), statsDate.getFullYear());
            
            // Contadores b√°sicos
            const total = registros.length;
            const excelentes = registros.filter(r => r.estado_fisico === 'excelente').length;
            const optimos = registros.filter(r => r.estado_fisico === 'optimo').length;
            const malos = registros.filter(r => r.estado_fisico === 'mal_estado').length;
            
            document.getElementById('totalExtintores').textContent = total;
            document.getElementById('extintoresExcelentes').textContent = excelentes;
            document.getElementById('extintoresOptimos').textContent = optimos;
            document.getElementById('extintoresMalos').textContent = malos;
            
            // Distribuci√≥n por tipo
            const co2Count = registros.filter(r => r.tipo === 'CO2').length;
            const pqsCount = registros.filter(r => r.tipo === 'PQS').length;
            
            const co2Percentage = total > 0 ? Math.round((co2Count / total) * 100) : 0;
            const pqsPercentage = total > 0 ? Math.round((pqsCount / total) * 100) : 0;
            
            document.getElementById('co2Percentage').textContent = `${co2Percentage}%`;
            document.getElementById('pqsPercentage').textContent = `${pqsPercentage}%`;
            document.getElementById('co2Progress').style.width = `${co2Percentage}%`;
            document.getElementById('pqsProgress').style.width = `${pqsPercentage}%`;
            
            // Alertas
            updateAlerts(registros);
        }

        function updateAlerts(registros) {
            const alertsContainer = document.getElementById('alertsList');
            const alerts = [];
            
            // Verificar caducidades pr√≥ximas (pr√≥ximos 30 d√≠as)
            const today = new Date();
            const thirtyDaysFromNow = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
            
            registros.forEach(registro => {
                if (registro.caducidad) {
                    const caducidad = new Date(registro.caducidad + 'T00:00:00');
                    if (caducidad <= thirtyDaysFromNow && caducidad >= today) {
                        alerts.push(`‚ö†Ô∏è Extintor en ${registro.ubicacion} caduca el ${caducidad.toLocaleDateString('es-ES')}`);
                    }
                }
                
                if (registro.estado_fisico === 'mal_estado') {
                    alerts.push(`üî¥ Extintor en ${registro.ubicacion} en mal estado f√≠sico`);
                }
                
                if (registro.manometro === 'baja_presion' || registro.manometro === 'sobre_presion') {
                    alerts.push(`üîß Extintor en ${registro.ubicacion} con problemas de presi√≥n`);
                }
                
                if (!registro.senalizacion) {
                    alerts.push(`üö® Extintor en ${registro.ubicacion} sin se√±alizaci√≥n`);
                }
                
                if (registro.tipo === 'PQS' && !registro.selloSeguridad) {
                    alerts.push(`üè∑Ô∏è Extintor PQS en ${registro.ubicacion} sin sello de seguridad`);
                }
            });
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<div class="alert alert-success">‚úÖ No hay alertas para este mes</div>';
            } else {
                alertsContainer.innerHTML = alerts.map(alert => 
                    `<div class="alert alert-warning">${alert}</div>`
                ).join('');
            }
        }

        // Generaci√≥n de PDF simple y confiable
        function generatePDF() {
            const registros = getRegistrosByMonth(reportDate.getMonth(), reportDate.getFullYear());
            
            if (registros.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros para generar el reporte', 'warning');
                return;
            }

            showAlert('üìÑ Generando reporte PDF...', 'success');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuraci√≥n del documento
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                let yPosition = margin;
                
                // T√≠tulo
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Reporte Mensual de Extintores', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;
                
                // Fecha del reporte
                const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(`${months[reportDate.getMonth()]} ${reportDate.getFullYear()}`, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 20;
                
                // Resumen estad√≠stico
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Resumen Estad√≠stico', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                
                const excelentes = registros.filter(r => r.estado_fisico === 'excelente').length;
                const optimos = registros.filter(r => r.estado_fisico === 'optimo').length;
                const malos = registros.filter(r => r.estado_fisico === 'mal_estado').length;
                
                doc.text(`Total de extintores revisados: ${registros.length}`, margin, yPosition);
                yPosition += 7;
                doc.text(`Estado excelente: ${excelentes}`, margin, yPosition);
                yPosition += 7;
                doc.text(`Estado √≥ptimo: ${optimos}`, margin, yPosition);
                yPosition += 7;
                doc.text(`Mal estado: ${malos}`, margin, yPosition);
                yPosition += 20;
                
                // Detalle de registros
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Detalle de Registros', margin, yPosition);
                yPosition += 15;
                
                registros.forEach((registro, index) => {
                    // Verificar si necesitamos una nueva p√°gina
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = margin;
                    }
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${registro.ubicacion}`, margin, yPosition);
                    yPosition += 7;
                    
                    doc.setFont(undefined, 'normal');
                    doc.text(`Tipo: ${registro.tipo} | Capacidad: ${registro.capacidad} kg`, margin + 5, yPosition);
                    yPosition += 5;
                    doc.text(`Estado f√≠sico: ${registro.estado_fisico.replace('_', ' ')}`, margin + 5, yPosition);
                    yPosition += 5;
                    doc.text(`Man√≥metro: ${registro.manometro.replace('_', ' ')}`, margin + 5, yPosition);
                    yPosition += 5;
                    doc.text(`Se√±alizaci√≥n: ${registro.senalizacion ? 'S√≠' : 'No'} | Seguros: ${registro.seguros ? 'S√≠' : 'No'}`, margin + 5, yPosition);
                    yPosition += 5;
                    if (registro.tipo === 'PQS') {
                        doc.text(`Sello de seguridad: ${registro.selloSeguridad ? 'S√≠' : 'No'}`, margin + 5, yPosition);
                        yPosition += 5;
                    }
                    doc.text(`Caducidad: ${registro.caducidad ? new Date(registro.caducidad + 'T00:00:00').toLocaleDateString('es-ES') : 'No especificada'}`, margin + 5, yPosition);
                    yPosition += 10;
                });
                
                // Pie de p√°gina
                const today = new Date();
                doc.setFontSize(10);
                doc.text(`Generado el ${today.toLocaleDateString('es-ES')} - ExtintorCheck Pro`, margin, doc.internal.pageSize.height - 10);
                
                // Nombre del archivo
                const fileName = `Reporte_Extintores_${months[reportDate.getMonth()]}_${reportDate.getFullYear()}.pdf`;
                
                // Descarga simple y directa
                doc.save(fileName);
                showAlert('üìÑ Reporte PDF descargado exitosamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Error al generar PDF:', error);
                showAlert('‚ùå Error al generar el PDF. Intenta nuevamente.', 'warning');
            }
        }

        // Gesti√≥n de datos
        function exportData() {
            const data = {
                registros: getRegistros(),
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `extintores_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('üì§ Datos exportados exitosamente', 'success');
        }

        function clearAllData() {
            if (confirm('¬øEst√°s seguro de eliminar todos los datos? Esta acci√≥n no se puede deshacer.')) {
                localStorage.removeItem('extintorRegistros');
                localStorage.removeItem('archivedMonths');
                loadRegistros();
                updateStats();
                showAlert('üóëÔ∏è Todos los datos han sido eliminados', 'warning');
            }
        }

        function resetMonthlyData() {
            const currentMonth = reportDate.getMonth();
            const currentYear = reportDate.getFullYear();
            
            if (!confirm(`¬øReiniciar todos los registros del mes actual? Esto eliminar√° todas las inspecciones de ${getMonthName(currentMonth)} ${currentYear}.`)) {
                return;
            }
            
            let registros = getRegistros();
            registros = registros.filter(r => !(r.mes === currentMonth && r.a√±o === currentYear));
            localStorage.setItem('extintorRegistros', JSON.stringify(registros));
            
            loadRegistros();
            updateStats();
            showAlert('üîÑ Mes actual reiniciado exitosamente', 'success');
        }

        function archiveCurrentMonth() {
            const currentMonth = reportDate.getMonth();
            const currentYear = reportDate.getFullYear();
            const registrosDelMes = getRegistrosByMonth(currentMonth, currentYear);
            
            if (registrosDelMes.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros para archivar en este mes', 'warning');
                return;
            }
            
            if (!confirm(`¬øArchivar ${registrosDelMes.length} registros del mes ${getMonthName(currentMonth)} ${currentYear}?`)) {
                return;
            }
            
            // Obtener archivos existentes
            let archivedMonths = JSON.parse(localStorage.getItem('archivedMonths') || '[]');
            
            // Crear archivo del mes
            const archivo = {
                mes: currentMonth,
                a√±o: currentYear,
                fechaArchivo: new Date().toISOString(),
                registros: registrosDelMes,
                totalExtintores: registrosDelMes.length,
                estadisticas: {
                    excelentes: registrosDelMes.filter(r => r.estado_fisico === 'excelente').length,
                    optimos: registrosDelMes.filter(r => r.estado_fisico === 'optimo').length,
                    malos: registrosDelMes.filter(r => r.estado_fisico === 'mal_estado').length
                }
            };
            
            // Verificar si ya existe un archivo para este mes
            const existingIndex = archivedMonths.findIndex(a => a.mes === currentMonth && a.a√±o === currentYear);
            if (existingIndex !== -1) {
                archivedMonths[existingIndex] = archivo;
            } else {
                archivedMonths.push(archivo);
            }
            
            // Guardar archivo
            localStorage.setItem('archivedMonths', JSON.stringify(archivedMonths));
            
            showAlert(`üì¶ Mes ${getMonthName(currentMonth)} ${currentYear} archivado exitosamente`, 'success');
        }

        function getMonthName(monthIndex) {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return months[monthIndex];
        }

        // Utilidades
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.left = '50%';
            alertDiv.style.transform = 'translateX(-50%)';
            alertDiv.style.zIndex = '1000';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.textAlign = 'center';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }


    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9914d607230e7244',t:'MTc2MDkyNDcyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
