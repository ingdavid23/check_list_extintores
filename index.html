<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExtintorCheck Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #ffffff 100%);
            min-height: 100%;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100%;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #ff6b6b;
            border-bottom: 2px solid #ff6b6b;
        }

        .tab-content {
            display: none;
            padding: 20px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .radio-option:hover {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .radio-option input[type="radio"] {
            margin: 0;
        }

        .radio-option input[type="radio"]:checked + span {
            color: #ff6b6b;
            font-weight: 600;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: inline-block;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-block {
            width: 100%;
            margin-bottom: 10px;
        }

        .extinguisher-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .extinguisher-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-weight: 600;
            color: #495057;
            margin: 0;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-excelente {
            background: #d4edda;
            color: #155724;
        }

        .status-optimo {
            background: #fff3cd;
            color: #856404;
        }

        .status-mal {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #ff6b6b;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient( #ff6b6b, #ff6b6b);
            transition: width 0.3s ease;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #ff6b6b;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .month-nav {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .current-month {
            flex: 1;
            text-align: center;
            font-weight: 600;
            color: #495057;
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üßØ ExtintorCheck Pro</h1>
            <div class="subtitle">Gesti√≥n Profesional de Extintores</div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('checklist')">üìã Check-list</button>
            <button class="nav-tab" onclick="showTab('registros')">üìÅ Registros</button>
            <button class="nav-tab" onclick="showTab('estadisticas')">üìä Estad√≠sticas</button>
            <button class="nav-tab" onclick="showTab('reportes')">üìÑ Reportes</button>
        </nav>

        <div id="checklist" class="tab-content active">
            <form id="extinguisherForm">
                <div class="form-group">
                    <label for="ubicacion">üìç Ubicaci√≥n</label>
                    <input type="text" id="ubicacion" class="form-control" placeholder="Ej: Planta baja - Pasillo A" required>
                </div>

                <div class="form-group">
                    <label>üî• Tipo de Extintor</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="tipo" value="CO2" required>
                            <span>CO2</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="tipo" value="PQS" required>
                            <span>PQS</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="capacidad">‚öñÔ∏è Capacidad (kg)</label>
                    <select id="capacidad" class="form-control" required>
                        <option value="">Seleccionar capacidad</option>
                        <option value="2">2 kg</option>
                        <option value="4">4 kg</option>
                        <option value="4.5">4.5 kg</option>
                        <option value="6">6 kg</option>
                        <option value="9">9 kg</option>
                        <option value="12">12 kg</option>
                        <option value="50">50 kg</option>
                        <option value="70">70 kg</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="senalizacion" name="senalizacion">
                        <label for="senalizacion">üö® Cuenta con se√±alizaci√≥n</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>üîß Estado del Man√≥metro</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="manometro" value="baja_presion" required>
                            <span>Baja Presi√≥n</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="manometro" value="presion_optima" required>
                            <span>Presi√≥n √ìptima</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="manometro" value="sobre_presion" required>
                            <span>Sobre Presi√≥n</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>üîó Estado de las Mangueras</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="mangueras" value="mal_estado" required>
                            <span>Mal Estado</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="mangueras" value="optimo" required>
                            <span>√ìptimo</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="mangueras" value="excelente" required>
                            <span>Excelente</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="seguros" name="seguros">
                        <label for="seguros">üîí Cuenta con seguros y cincho</label>
                    </div>
                </div>

                <div class="form-group" id="selloSeguridadGroup" style="display: none;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="selloSeguridad" name="selloSeguridad">
                        <label for="selloSeguridad">üè∑Ô∏è Cuenta con sello de seguridad (Solo PQS)</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>üí® Estado del Difusor</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="difusor" value="mal_estado" required>
                            <span>Mal Estado</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difusor" value="optimo" required>
                            <span>√ìptimo</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difusor" value="excelente" required>
                            <span>Excelente</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="caducidad">üìÖ Fecha de Caducidad</label>
                    <input type="date" id="caducidad" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>üè• Estado F√≠sico General</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="estado_fisico" value="mal_estado" required>
                            <span>Mal Estado</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="estado_fisico" value="optimo" required>
                            <span>√ìptimo</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="estado_fisico" value="excelente" required>
                            <span>Excelente</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">üíæ Guardar Registro</button>
            </form>
        </div>

        <div id="registros" class="tab-content">
            <div class="month-selector">
                <button class="month-nav" onclick="changeRegistrosMonth(-1)">‚Äπ</button>
                <div class="current-month" id="registrosMonth"></div>
                <button class="month-nav" onclick="changeRegistrosMonth(1)">‚Ä∫</button>
            </div>
            <div id="registrosList"></div>
        </div>

        <div id="estadisticas" class="tab-content">
            <div class="month-selector">
                <button class="month-nav" onclick="changeStatsMonth(-1)">‚Äπ</button>
                <div class="current-month" id="statsMonth"></div>
                <button class="month-nav" onclick="changeStatsMonth(1)">‚Ä∫</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalExtintores">0</div>
                    <div class="stat-label">Total Extintores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="extintoresExcelentes">0</div>
                    <div class="stat-label">Excelente Estado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="extintoresOptimos">0</div>
                    <div class="stat-label">Estado √ìptimo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="extintoresMalos">0</div>
                    <div class="stat-label">Mal Estado</div>
                </div>
            </div>

            <div class="stat-card">
                <h3 style="margin-top: 0; color: #495057;">üìä Distribuci√≥n por Tipo</h3>
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>CO2</span>
                        <span id="co2Percentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="co2Progress" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span>PQS</span>
                        <span id="pqsPercentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="pqsProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3 style="margin-top: 0; color: #495057;">‚ö†Ô∏è Alertas del Mes</h3>
                <div id="alertsList"></div>
            </div>
        </div>

        <div id="reportes" class="tab-content">
            <div class="month-selector">
                <button class="month-nav" onclick="changeReportMonth(-1)">‚Äπ</button>
                <div class="current-month" id="reportMonth"></div>
                <button class="month-nav" onclick="changeReportMonth(1)">‚Ä∫</button>
            </div>

            <div class="stat-card" style="margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #495057;">üìÑ Gestor de Reportes</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">
                    Genera, visualiza y descarga reportes de tus inspecciones mensuales.
                </p>
                <div style="text-align: center;">
                    <button onclick="generateAndPreviewReport()" class="btn btn-primary">
                        üëÅÔ∏è Generar y Visualizar
                    </button>
                  </div>

            <div id="pdfManager" class="stat-card" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #495057;">üìÅ PDFs Guardados</h3>
                    <button onclick="clearAllPDFs()" class="btn" style="background: #dc3545; color: white; padding: 6px 12px; font-size: 12px;">
                        üóëÔ∏è Limpiar Todo
                    </button>
                </div>
                <div id="pdfList"></div>
            </div>

            <div id="reportViewer" class="stat-card" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #495057;">üëÅÔ∏è Vista Previa (Texto)</h3>
                    <button onclick="closeReportViewer()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                        ‚ùå Cerrar
                    </button>
                </div>
                <div style="background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                    <textarea id="textPreview" readonly style="width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; box-sizing: border-box; resize: vertical; font-family: monospace; font-size: 12px;"></textarea>
                </div>
                <button onclick="copyReportText()" class="btn btn-primary btn-block">
                    üìã Copiar Texto del Reporte
                </button>
            </div>
            <div class="stat-card">
                <h3 style="margin-top: 0; color: #495057;">üîÑ Gesti√≥n Mensual</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">
                    Herramientas para gestionar el ciclo mensual de inspecciones.
                </p>
                <button onclick="resetMonthlyData()" class="btn" style="background: #17a2b8; color: white; margin-bottom: 10px;" class="btn-block">
                    üîÑ Reiniciar Mes Actual
                </button>
                <button onclick="archiveCurrentMonth()" class="btn" style="background: #6f42c1; color: white;" class="btn-block">
                    üì¶ Archivar Mes Actual
                </button>
            </div>

            <div class="stat-card">
                <h3 style="margin-top: 0; color: #495057;">üíæ Gesti√≥n de Datos</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">
                    Todos los datos se almacenan localmente en tu dispositivo para garantizar la privacidad y disponibilidad offline.
                </p>
                <button onclick="exportData()" class="btn btn-secondary btn-block">
                    üì§ Exportar Datos JSON
                </button>
                <button onclick="clearAllData()" class="btn" style="background: #dc3545; color: white; margin-top: 10px;" onclick="return confirm('¬øEst√°s seguro de eliminar todos los datos?')">
                    üóëÔ∏è Limpiar Todos los Datos
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentDate = new Date();
        let registrosDate = new Date();
        let statsDate = new Date();
        let reportDate = new Date();

        // Variables globales para PDF
        let currentPDFData = null;
        let currentPDFBlob = null;
        let currentPDFURL = null;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            updateMonthDisplays();
            loadRegistros();
            updateStats();
            updatePDFCount();
            
            // Configurar formulario
            document.getElementById('extinguisherForm').addEventListener('submit', handleFormSubmit);
            
            // Configurar eventos para mostrar/ocultar sello de seguridad
            document.querySelectorAll('input[name="tipo"]').forEach(radio => {
                radio.addEventListener('change', toggleSelloSeguridad);
            });
            
            // Verificar y cargar autom√°ticamente registros del mes actual
            autoLoadCurrentMonthRegistros();
        });

        // Funci√≥n para mostrar/ocultar sello de seguridad
        function toggleSelloSeguridad() {
            const tipoSeleccionado = document.querySelector('input[name="tipo"]:checked');
            const selloGroup = document.getElementById('selloSeguridadGroup');
            const selloCheckbox = document.getElementById('selloSeguridad');
            
            if (tipoSeleccionado && tipoSeleccionado.value === 'PQS') {
                selloGroup.style.display = 'block';
            } else {
                selloGroup.style.display = 'none';
                selloCheckbox.checked = false; // Limpiar si no es PQS
            }
        }

        // Gesti√≥n de pesta√±as
        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Actualizar contenido seg√∫n la pesta√±a
            if (tabName === 'registros') {
                loadRegistros();
            } else if (tabName === 'estadisticas') {
                updateStats();
            }
        }

        // Gesti√≥n de fechas
        function updateMonthDisplays() {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            document.getElementById('registrosMonth').textContent = 
                `${months[registrosDate.getMonth()]} ${registrosDate.getFullYear()}`;
            document.getElementById('statsMonth').textContent = 
                `${months[statsDate.getMonth()]} ${statsDate.getFullYear()}`;
            document.getElementById('reportMonth').textContent = 
                `${months[reportDate.getMonth()]} ${reportDate.getFullYear()}`;
        }

        function changeRegistrosMonth(direction) {
            registrosDate.setMonth(registrosDate.getMonth() + direction);
            updateMonthDisplays();
            loadRegistros();
        }

        function changeStatsMonth(direction) {
            statsDate.setMonth(statsDate.getMonth() + direction);
            updateMonthDisplays();
            updateStats();
        }

        function changeReportMonth(direction) {
            reportDate.setMonth(reportDate.getMonth() + direction);
            updateMonthDisplays();
        }

        // Manejo del formulario
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            const editingId = form.dataset.editingId;
            
            // Validar que todos los campos requeridos est√©n completos
            const tipoSeleccionado = formData.get('tipo');
            const manometroSeleccionado = formData.get('manometro');
            const manguerasSeleccionado = formData.get('mangueras');
            const difusorSeleccionado = formData.get('difusor');
            const estadoFisicoSeleccionado = formData.get('estado_fisico');
            
            if (!tipoSeleccionado || !manometroSeleccionado || !manguerasSeleccionado || 
                !difusorSeleccionado || !estadoFisicoSeleccionado) {
                showAlert('‚ö†Ô∏è Por favor completa todos los campos requeridos', 'warning');
                return;
            }
            
            const registro = {
                id: editingId ? parseInt(editingId) : Date.now(),
                ubicacion: document.getElementById('ubicacion').value.trim() || '',
                tipo: tipoSeleccionado,
                capacidad: document.getElementById('capacidad').value,
                senalizacion: document.getElementById('senalizacion').checked,
                manometro: manometroSeleccionado,
                mangueras: manguerasSeleccionado,
                seguros: document.getElementById('seguros').checked,
                selloSeguridad: document.getElementById('selloSeguridad').checked,
                difusor: difusorSeleccionado,
                caducidad: document.getElementById('caducidad').value || '',
                estado_fisico: estadoFisicoSeleccionado
            };
            
            // Solo asignar mes y a√±o para NUEVOS registros, NO para ediciones
            if (!editingId) {
                const today = new Date();
                registro.mes = today.getMonth();
                registro.a√±o = today.getFullYear();
                registro.fecha = new Date().toISOString();
            }
            
            if (editingId) {
                // Actualizar registro existente
                const success = updateRegistro(registro);
                if (success) {
                    showAlert('‚úÖ Registro actualizado exitosamente', 'success');
                    // Salir del modo edici√≥n
                    cancelEdit();
                } else {
                    showAlert('‚ùå Error al actualizar el registro', 'warning');
                }
            } else {
                // Guardar nuevo registro (fecha ya asignada arriba)
                const guardadoExitoso = saveRegistro(registro);
                
                if (guardadoExitoso) {
                    showAlert('‚úÖ Registro guardado exitosamente', 'success');
                    
                    // Limpiar formulario
                    form.reset();
                    // Ocultar sello de seguridad al limpiar
                    document.getElementById('selloSeguridadGroup').style.display = 'none';
                } else {
                    showAlert('‚ùå Error al guardar el registro', 'warning');
                    return; // No limpiar el formulario si hubo error
                }
            }
            
            // Actualizar estad√≠sticas
            updateStats();
        }

        function saveRegistro(registro) {
            console.log('üíæ Guardando registro:', registro);
            
            // Validar que el registro tenga los campos requeridos
            if (!registro.ubicacion || !registro.tipo || typeof registro.mes !== 'number' || typeof registro.a√±o !== 'number') {
                console.error('‚ùå Registro inv√°lido:', registro);
                showAlert('‚ùå Error: Registro con datos incompletos', 'warning');
                return false;
            }
            
            try {
                let registros = JSON.parse(localStorage.getItem('extintorRegistros') || '[]');
                console.log('üíæ Registros existentes:', registros.length);
                
                // Asegurar que el registro tenga un ID √∫nico
                if (!registro.id) {
                    registro.id = Date.now() + Math.floor(Math.random() * 10000);
                }
                
                // Verificar que no exista un registro con el mismo ID
                const existeId = registros.some(r => r.id === registro.id);
                if (existeId) {
                    registro.id = Date.now() + Math.floor(Math.random() * 10000);
                    console.log('üíæ ID duplicado detectado, generando nuevo ID:', registro.id);
                }
                
                registros.push(registro);
                localStorage.setItem('extintorRegistros', JSON.stringify(registros));
                
                // Verificar que se guard√≥ correctamente
                const verificacion = JSON.parse(localStorage.getItem('extintorRegistros') || '[]');
                const registroGuardado = verificacion.find(r => r.id === registro.id);
                
                if (!registroGuardado) {
                    throw new Error('El registro no se guard√≥ correctamente');
                }
                
                console.log('‚úÖ Registro guardado exitosamente:', {
                    id: registro.id,
                    ubicacion: registro.ubicacion,
                    mes: registro.mes,
                    a√±o: registro.a√±o
                });
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error al guardar registro:', error);
                showAlert('‚ùå Error al guardar el registro', 'warning');
                return false;
            }
        }

        function updateRegistro(registroActualizado) {
            let registros = getRegistros();
            const index = registros.findIndex(r => r.id == registroActualizado.id);
            
            if (index !== -1) {
                const registroOriginal = registros[index];
                
                registros[index] = {
                    ...registros[index],
                    ...registroActualizado,
                    id: registros[index].id,
                    fecha: registros[index].fecha,
                    mes: registros[index].mes,
                    a√±o: registros[index].a√±o,
                    fechaActualizacion: new Date().toISOString()
                };
                
                console.log('‚úèÔ∏è Registro actualizado correctamente:', {
                    id: registros[index].id,
                    ubicacion: registros[index].ubicacion,
                    mesOriginal: registroOriginal.mes,
                    a√±oOriginal: registroOriginal.a√±o,
                    mesMantenido: registros[index].mes,
                    a√±oMantenido: registros[index].a√±o
                });
                
                localStorage.setItem('extintorRegistros', JSON.stringify(registros));
                loadRegistros();
                return true;
            }
            return false;
        }

        function getRegistros() {
            return JSON.parse(localStorage.getItem('extintorRegistros') || '[]');
        }

        function getRegistrosByMonth(mes, a√±o) {
            const registros = getRegistros();
            return registros.filter(r => r.mes === mes && r.a√±o === a√±o);
        }

        function loadRegistros() {
            const registros = getRegistrosByMonth(registrosDate.getMonth(), registrosDate.getFullYear());
            const container = document.getElementById('registrosList');
            
            if (registros.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No hay registros</h3>
                        <p>No se encontraron registros para este mes.</p>
                        <button onclick="copyPreviousMonthRegistros()" class="btn btn-primary" style="margin-top: 15px;">
                            üîÑ Actualizar desde Mes Anterior
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = registros.map(registro => `
                <div class="extinguisher-card">
                    <div class="card-header">
                        <h4 class="card-title">üìç ${registro.ubicacion}</h4>
                        <span class="status-badge status-${registro.estado_fisico.replace('_', '-')}">
                            ${registro.estado_fisico.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                        <div><strong>Tipo:</strong> ${registro.tipo}</div>
                        <div><strong>Capacidad:</strong> ${registro.capacidad} kg</div>
                        <div><strong>Man√≥metro:</strong> ${registro.manometro.replace('_', ' ')}</div>
                        <div><strong>Mangueras:</strong> ${registro.mangueras}</div>
                        <div><strong>Difusor:</strong> ${registro.difusor}</div>
                        <div><strong>Se√±alizaci√≥n:</strong> ${registro.senalizacion ? '‚úÖ' : '‚ùå'}</div>
                        <div><strong>Seguros:</strong> ${registro.seguros ? '‚úÖ' : '‚ùå'}</div>
                        ${registro.tipo === 'PQS' ? `<div><strong>Sello Seguridad:</strong> ${registro.selloSeguridad ? '‚úÖ' : '‚ùå'}</div>` : ''}
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef; font-size: 12px; color: #6c757d;">
                        <strong>Caducidad:</strong> ${registro.caducidad ? new Date(registro.caducidad + 'T00:00:00').toLocaleDateString('es-ES') : 'No especificada'} | 
                        <strong>Registrado:</strong> ${new Date(registro.fecha).toLocaleDateString('es-ES')}
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button onclick="editRegistro(${registro.id})" class="btn btn-secondary" style="flex: 1; padding: 6px 12px; font-size: 12px;">
                            ‚úèÔ∏è Editar
                        </button>
                        <button onclick="deleteRegistro(${registro.id})" class="btn" style="background: #dc3545; color: white; flex: 1; padding: 6px 12px; font-size: 12px;">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteRegistro(id) {
            if (confirm('¬øEst√°s seguro de eliminar este registro?')) {
                let registros = getRegistros();
                registros = registros.filter(r => r.id != id);
                localStorage.setItem('extintorRegistros', JSON.stringify(registros));
                loadRegistros();
                updateStats();
                showAlert('üóëÔ∏è Registro eliminado', 'warning');
            }
        }

        function editRegistro(id) {
            const registros = getRegistros();
            const registro = registros.find(r => r.id === id);
            
            if (!registro) {
                showAlert('‚ùå Registro no encontrado', 'warning');
                return;
            }
            
            showTab('checklist');
            document.querySelector('[onclick="showTab(\'checklist\')"]').classList.add('active');
            
            setTimeout(() => {
                document.getElementById('ubicacion').value = registro.ubicacion || '';
                const tipoRadio = document.querySelector(`input[name="tipo"][value="${registro.tipo}"]`);
                if (tipoRadio) tipoRadio.checked = true;
                document.getElementById('capacidad').value = registro.capacidad || '';
                document.getElementById('senalizacion').checked = registro.senalizacion || false;
                const manometroRadio = document.querySelector(`input[name="manometro"][value="${registro.manometro}"]`);
                if (manometroRadio) manometroRadio.checked = true;
                const manguerasRadio = document.querySelector(`input[name="mangueras"][value="${registro.mangueras}"]`);
                if (manguerasRadio) manguerasRadio.checked = true;
                document.getElementById('seguros').checked = registro.seguros || false;
                document.getElementById('selloSeguridad').checked = registro.selloSeguridad || false;
                toggleSelloSeguridad();
                const difusorRadio = document.querySelector(`input[name="difusor"][value="${registro.difusor}"]`);
                if (difusorRadio) difusorRadio.checked = true;
                document.getElementById('caducidad').value = registro.caducidad || '';
                const estadoRadio = document.querySelector(`input[name="estado_fisico"][value="${registro.estado_fisico}"]`);
                if (estadoRadio) estadoRadio.checked = true;
            }, 100);
            
            const form = document.getElementById('extinguisherForm');
            form.dataset.editingId = id;
            
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = '‚úèÔ∏è Actualizar Registro';
            submitBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
            
            if (!document.getElementById('cancelEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.id = 'cancelEditBtn';
                cancelBtn.className = 'btn btn-secondary btn-block';
                cancelBtn.textContent = '‚ùå Cancelar Edici√≥n';
                cancelBtn.onclick = cancelEdit;
                form.appendChild(cancelBtn);
            }
            
            showAlert('‚úèÔ∏è Modo edici√≥n activado', 'success');
        }

        function cancelEdit() {
            const form = document.getElementById('extinguisherForm');
            delete form.dataset.editingId;
            
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'üíæ Guardar Registro';
            submitBtn.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a24)';
            
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
            
            form.reset();
            document.getElementById('selloSeguridadGroup').style.display = 'none';
            document.getElementById('selloSeguridad').checked = false;
            
            showAlert('‚ùå Edici√≥n cancelada', 'warning');
        }

        function autoLoadCurrentMonthRegistros() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            console.log('üîç Verificando registros para mes actual:', getMonthName(currentMonth), currentYear);
            
            const existingRegistros = getRegistrosByMonth(currentMonth, currentYear);
            
            if (existingRegistros.length === 0) {
                console.log('üìÖ No hay registros en el mes actual, buscando mes anterior...');
                
                let previousMonth = currentMonth - 1;
                let previousYear = currentYear;
                
                if (previousMonth < 0) {
                    previousMonth = 11;
                    previousYear = currentYear - 1;
                }
                
                const previousRegistros = getRegistrosByMonth(previousMonth, previousYear);
                
                if (previousRegistros.length > 0) {
                    console.log(`üîÑ Encontrados ${previousRegistros.length} registros en ${getMonthName(previousMonth)} ${previousYear}`);
                    
                    updateRegistrosToCurrentMonth(
                        previousRegistros, 
                        currentMonth, 
                        currentYear, 
                        `${getMonthName(previousMonth)} ${previousYear}`,
                        true
                    );
                } else {
                    console.log('‚ö†Ô∏è No se encontraron registros del mes anterior');
                }
            } else {
                console.log(`‚úÖ Ya existen ${existingRegistros.length} registros en el mes actual`);
            }
        }

        function copyPreviousMonthRegistros() {
            const targetMonth = registrosDate.getMonth();
            const targetYear = registrosDate.getFullYear();
            
            console.log('üîç Actualizando registros para mes visualizado:', getMonthName(targetMonth), targetYear);
            
            const existingRegistros = getRegistrosByMonth(targetMonth, targetYear);
            if (existingRegistros.length > 0) {
                if (!confirm(`Ya existen ${existingRegistros.length} registros en ${getMonthName(targetMonth)} ${targetYear}. ¬øDeseas reemplazarlos con los datos del mes anterior?`)) {
                    return;
                }
                updateExistingRegistrosFromPrevious(targetMonth, targetYear);
                return;
            }
            
            let previousMonth = targetMonth - 1;
            let previousYear = targetYear;
            
            if (previousMonth < 0) {
                previousMonth = 11;
                previousYear = targetYear - 1;
            }
            
            console.log('üîç Buscando en mes anterior:', getMonthName(previousMonth), previousYear);
            
            const previousRegistros = getRegistrosByMonth(previousMonth, previousYear);
            
            if (previousRegistros.length === 0) {
                let searchMonth = previousMonth;
                let searchYear = previousYear;
                let foundRegistros = [];
                let monthsSearched = 0;
                
                while (foundRegistros.length === 0 && monthsSearched < 12) {
                    searchMonth--;
                    monthsSearched++;
                    
                    if (searchMonth < 0) {
                        searchMonth = 11;
                        searchYear--;
                    }
                    
                    foundRegistros = getRegistrosByMonth(searchMonth, searchYear);
                    console.log(`üîç Buscando en ${getMonthName(searchMonth)} ${searchYear}: ${foundRegistros.length} registros`);
                }
                
                if (foundRegistros.length === 0) {
                    showAlert('‚ö†Ô∏è No se encontraron registros en los √∫ltimos 12 meses para actualizar', 'warning');
                    return;
                }
                
                const monthName = getMonthName(searchMonth);
                if (!confirm(`No hay registros del mes anterior. ¬øCopiar ${foundRegistros.length} extintores de ${monthName} ${searchYear} a ${getMonthName(targetMonth)} ${targetYear}?`)) {
                    return;
                }
                
                updateRegistrosToCurrentMonth(foundRegistros, targetMonth, targetYear, `${monthName} ${searchYear}`);
                return;
            }
            
            const previousMonthName = getMonthName(previousMonth);
            if (!confirm(`¬øCopiar ${previousRegistros.length} extintores desde ${previousMonthName} ${previousYear} a ${getMonthName(targetMonth)} ${targetYear}? Esto copiar√° todos los datos del mes anterior.`)) {
                return;
            }
            
            updateRegistrosToCurrentMonth(previousRegistros, targetMonth, targetYear, `${previousMonthName} ${previousYear}`);
        }

        function updateRegistrosToCurrentMonth(sourceRegistros, targetMonth, targetYear, sourceName, silentMode = false) {
            console.log('üîÑ Iniciando actualizaci√≥n de registros...');
            console.log('üîÑ Registros origen:', sourceRegistros.length);
            console.log('üîÑ Mes destino:', getMonthName(targetMonth), targetYear);
            
            if (!sourceRegistros || sourceRegistros.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros v√°lidos para actualizar', 'warning');
                return;
            }
            
            const timestamp = Date.now();
            const nuevosRegistros = sourceRegistros.map((registro, index) => {
                if (!registro.ubicacion || !registro.tipo) {
                    console.warn('‚ö†Ô∏è Registro origen incompleto:', registro);
                    return null;
                }
                
                const nuevoRegistro = {
                    id: timestamp + index + Math.floor(Math.random() * 10000),
                    fecha: new Date().toISOString(),
                    mes: parseInt(targetMonth),
                    a√±o: parseInt(targetYear),
                    
                    ubicacion: String(registro.ubicacion).trim(),
                    tipo: registro.tipo || 'CO2',
                    capacidad: registro.capacidad || '6',
                    caducidad: registro.caducidad || '',
                    senalizacion: registro.senalizacion || false,
                    manometro: registro.manometro || 'presion_optima',
                    mangueras: registro.mangueras || 'optimo',
                    seguros: registro.seguros || false,
                    selloSeguridad: registro.selloSeguridad || false,
                    difusor: registro.difusor || 'optimo',
                    estado_fisico: registro.estado_fisico || 'optimo',
                    
                    actualizadoDe: sourceName,
                    fechaActualizacion: new Date().toISOString(),
                    copiaDe: `${getMonthName(registro.mes)} ${registro.a√±o}`
                };
                
                console.log('üîÑ Registro copiado completo:', {
                    id: nuevoRegistro.id,
                    ubicacion: nuevoRegistro.ubicacion,
                    mes: nuevoRegistro.mes,
                    a√±o: nuevoRegistro.a√±o,
                    estado_fisico: nuevoRegistro.estado_fisico,
                    manometro: nuevoRegistro.manometro
                });
                
                return nuevoRegistro;
            }).filter(registro => registro !== null);
            
            if (nuevosRegistros.length === 0) {
                showAlert('‚ö†Ô∏è No se pudieron crear registros v√°lidos', 'warning');
                return;
            }
            
            let todosLosRegistros = getRegistros();
            console.log('üîÑ Registros existentes antes de actualizaci√≥n:', todosLosRegistros.length);
            
            const registrosExistentesDelMes = todosLosRegistros.filter(r => 
                parseInt(r.mes) === parseInt(targetMonth) && parseInt(r.a√±o) === parseInt(targetYear)
            );
            
            console.log('üîÑ Registros existentes en mes destino:', registrosExistentesDelMes.length);
            
            const nuevosRegistrosFiltrados = nuevosRegistros.filter(nuevo => {
                const yaExiste = registrosExistentesDelMes.some(existente => 
                    String(existente.ubicacion).toLowerCase().trim() === String(nuevo.ubicacion).toLowerCase().trim()
                );
                if (yaExiste) {
                    console.log('üîÑ Duplicado omitido:', nuevo.ubicacion);
                }
                return !yaExiste;
            });
            
            if (nuevosRegistrosFiltrados.length === 0) {
                showAlert('‚ö†Ô∏è Todos los extintores ya existen en este mes', 'warning');
                return;
            }
            
            if (nuevosRegistrosFiltrados.length < nuevosRegistros.length && !silentMode) {
                const duplicados = nuevosRegistros.length - nuevosRegistrosFiltrados.length;
                if (!confirm(`Se encontraron ${duplicados} extintores duplicados que ser√°n omitidos. ¬øContinuar actualizando ${nuevosRegistrosFiltrados.length} extintores?`)) {
                    return;
                }
            }
            
            todosLosRegistros = todosLosRegistros.concat(nuevosRegistrosFiltrados);
            console.log('üîÑ Total registros despu√©s de actualizaci√≥n:', todosLosRegistros.length);
            
            const registrosValidos = todosLosRegistros.filter(r => 
                r && r.id && r.ubicacion && r.tipo && 
                typeof r.mes === 'number' && typeof r.a√±o === 'number'
            );
            
            if (registrosValidos.length !== todosLosRegistros.length) {
                console.error('‚ö†Ô∏è Se encontraron registros inv√°lidos, limpiando...');
                todosLosRegistros = registrosValidos;
            }
            
            try {
                localStorage.setItem('extintorRegistros', JSON.stringify(todosLosRegistros));
                console.log('‚úÖ Registros guardados exitosamente');
                
                const verificacion = JSON.parse(localStorage.getItem('extintorRegistros') || '[]');
                if (verificacion.length !== todosLosRegistros.length) {
                    throw new Error('Error en la verificaci√≥n del guardado');
                }
                
            } catch (error) {
                console.error('‚ùå Error al guardar registros:', error);
                showAlert('‚ùå Error al guardar los registros actualizados', 'warning');
                return;
            }
            
            loadRegistros();
            updateStats();
            
            if (!silentMode) {
                showAlert(`‚úÖ ${nuevosRegistrosFiltrados.length} extintores copiados completamente desde ${sourceName} a ${getMonthName(targetMonth)} ${targetYear}. Ahora solo edita los que necesites actualizar.`, 'success');
            } else {
                console.log(`‚úÖ Carga autom√°tica: ${nuevosRegistrosFiltrados.length} extintores copiados desde ${sourceName} a ${getMonthName(targetMonth)} ${targetYear}`);
            }
            
            console.log('‚úÖ Extintores actualizados exitosamente:', nuevosRegistrosFiltrados.map(r => ({
                id: r.id,
                ubicacion: r.ubicacion,
                tipo: r.tipo,
                capacidad: r.capacidad,
                mes: r.mes,
                a√±o: r.a√±o
            })));
        }

        function updateExistingRegistrosFromPrevious(targetMonth, targetYear) {
            console.log('üîÑ Actualizando registros existentes...');
            
            let previousMonth = targetMonth - 1;
            let previousYear = targetYear;
            
            if (previousMonth < 0) {
                previousMonth = 11;
                previousYear = targetYear - 1;
            }
            
            const previousRegistros = getRegistrosByMonth(previousMonth, previousYear);
            
            if (previousRegistros.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros del mes anterior para actualizar', 'warning');
                return;
            }
            
            let todosLosRegistros = getRegistros();
            let registrosActualizados = 0;
            let registrosNuevos = 0;
            
            previousRegistros.forEach(prevRegistro => {
                if (!prevRegistro.ubicacion || !prevRegistro.tipo) return;
                
                const existingIndex = todosLosRegistros.findIndex(r => 
                    parseInt(r.mes) === parseInt(targetMonth) && 
                    parseInt(r.a√±o) === parseInt(targetYear) &&
                    String(r.ubicacion).toLowerCase().trim() === String(prevRegistro.ubicacion).toLowerCase().trim()
                );
                
                if (existingIndex !== -1) {
                    const registroExistente = todosLosRegistros[existingIndex];
                    todosLosRegistros[existingIndex] = {
                        id: registroExistente.id,
                        fecha: registroExistente.fecha,
                        mes: parseInt(targetMonth),
                        a√±o: parseInt(targetYear),
                        
                        ubicacion: String(prevRegistro.ubicacion).trim(),
                        tipo: prevRegistro.tipo,
                        capacidad: prevRegistro.capacidad,
                        caducidad: prevRegistro.caducidad,
                        senalizacion: prevRegistro.senalizacion || false,
                        manometro: prevRegistro.manometro || 'presion_optima',
                        mangueras: prevRegistro.mangueras || 'optimo',
                        seguros: prevRegistro.seguros || false,
                        selloSeguridad: prevRegistro.selloSeguridad || false,
                        difusor: prevRegistro.difusor || 'optimo',
                        estado_fisico: prevRegistro.estado_fisico || 'optimo',
                        
                        actualizadoDe: `${getMonthName(previousMonth)} ${previousYear}`,
                        fechaActualizacionCompleta: new Date().toISOString(),
                        copiaDe: `${getMonthName(previousMonth)} ${previousYear}`
                    };
                    registrosActualizados++;
                    console.log('üîÑ Registro completamente actualizado:', prevRegistro.ubicacion);
                } else {
                    const nuevoRegistro = {
                        id: Date.now() + Math.floor(Math.random() * 10000),
                        fecha: new Date().toISOString(),
                        mes: parseInt(targetMonth),
                        a√±o: parseInt(targetYear),
                        
                        ubicacion: String(prevRegistro.ubicacion).trim(),
                        tipo: prevRegistro.tipo,
                        capacidad: prevRegistro.capacidad,
                        caducidad: prevRegistro.caducidad,
                        senalizacion: prevRegistro.senalizacion || false,
                        manometro: prevRegistro.manometro || 'presion_optima',
                        mangueras: prevRegistro.mangueras || 'optimo',
                        seguros: prevRegistro.seguros || false,
                        selloSeguridad: prevRegistro.selloSeguridad || false,
                        difusor: prevRegistro.difusor || 'optimo',
                        estado_fisico: prevRegistro.estado_fisico || 'optimo',
                        
                        actualizadoDe: `${getMonthName(previousMonth)} ${previousYear}`,
                        fechaActualizacion: new Date().toISOString(),
                        copiaDe: `${getMonthName(previousMonth)} ${previousYear}`
                    };
                    
                    todosLosRegistros.push(nuevoRegistro);
                    registrosNuevos++;
                    console.log('üîÑ Nuevo registro copiado completo:', prevRegistro.ubicacion);
                }
            });
            
            try {
                localStorage.setItem('extintorRegistros', JSON.stringify(todosLosRegistros));
                
                loadRegistros();
                updateStats();
                
                let mensaje = '‚úÖ Registros copiados completamente: ';
                if (registrosActualizados > 0) mensaje += `${registrosActualizados} actualizados con todos los datos`;
                if (registrosNuevos > 0) {
                    if (registrosActualizados > 0) mensaje += ', ';
                    mensaje += `${registrosNuevos} nuevos copiados`;
                }
                mensaje += '. Ahora solo edita los registros que necesites actualizar.';
                
                showAlert(mensaje, 'success');
                
            } catch (error) {
                console.error('‚ùå Error al guardar actualizaciones:', error);
                showAlert('‚ùå Error al guardar las actualizaciones', 'warning');
            }
        }

        // Estad√≠sticas
        function updateStats() {
            const registros = getRegistrosByMonth(statsDate.getMonth(), statsDate.getFullYear());
            
            const total = registros.length;
            const excelentes = registros.filter(r => r.estado_fisico === 'excelente').length;
            const optimos = registros.filter(r => r.estado_fisico === 'optimo').length;
            const malos = registros.filter(r => r.estado_fisico === 'mal_estado').length;
            
            document.getElementById('totalExtintores').textContent = total;
            document.getElementById('extintoresExcelentes').textContent = excelentes;
            document.getElementById('extintoresOptimos').textContent = optimos;
            document.getElementById('extintoresMalos').textContent = malos;
            
            const co2Count = registros.filter(r => r.tipo === 'CO2').length;
            const pqsCount = registros.filter(r => r.tipo === 'PQS').length;
            
            const co2Percentage = total > 0 ? Math.round((co2Count / total) * 100) : 0;
            const pqsPercentage = total > 0 ? Math.round((pqsCount / total) * 100) : 0;
            
            document.getElementById('co2Percentage').textContent = `${co2Percentage}%`;
            document.getElementById('pqsPercentage').textContent = `${pqsPercentage}%`;
            document.getElementById('co2Progress').style.width = `${co2Percentage}%`;
            document.getElementById('pqsProgress').style.width = `${pqsPercentage}%`;
            
            updateAlerts(registros);
        }

        function updateAlerts(registros) {
            const alertsContainer = document.getElementById('alertsList');
            const alerts = [];
            
            const today = new Date();
            const thirtyDaysFromNow = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
            
            registros.forEach(registro => {
                if (registro.caducidad) {
                    const caducidad = new Date(registro.caducidad + 'T00:00:00');
                    if (caducidad <= thirtyDaysFromNow && caducidad >= today) {
                        alerts.push(`‚ö†Ô∏è Extintor en ${registro.ubicacion} caduca el ${caducidad.toLocaleDateString('es-ES')}`);
                    }
                }
                
                if (registro.estado_fisico === 'mal_estado') {
                    alerts.push(`üî¥ Extintor en ${registro.ubicacion} en mal estado f√≠sico`);
                }
                
                if (registro.manometro === 'baja_presion' || registro.manometro === 'sobre_presion') {
                    alerts.push(`üîß Extintor en ${registro.ubicacion} con problemas de presi√≥n`);
                }
                
                if (!registro.senalizacion) {
                    alerts.push(`üö® Extintor en ${registro.ubicacion} sin se√±alizaci√≥n`);
                }
                
                if (registro.tipo === 'PQS' && !registro.selloSeguridad) {
                    alerts.push(`üè∑Ô∏è Extintor PQS en ${registro.ubicacion} sin sello de seguridad`);
                }
            });
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<div class="alert alert-success">‚úÖ No hay alertas para este mes</div>';
            } else {
                alertsContainer.innerHTML = alerts.map(alert => 
                    `<div class="alert alert-warning">${alert}</div>`
                ).join('');
            }
        }

        function isAndroidAPK() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isAndroid = userAgent.includes('android');
            const isWebView = userAgent.includes('wv') || 
                                window.navigator.standalone === false ||
                                !window.chrome ||
                                typeof window.orientation !== 'undefined';
            
            return isAndroid && isWebView;
        }
        
        // ===== NEW & MODIFIED FUNCTIONS FOR TXT REPORT START =====

        function generateAndPreviewReport() {
            const registros = getRegistrosByMonth(reportDate.getMonth(), reportDate.getFullYear());
            
            if (registros.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros para generar el reporte', 'warning');
                return;
            }

            showAlert('üìÑ Generando vista previa de texto...', 'success');
            
            const reportText = generateTXTContent(registros);
            showTXTPreview(reportText);
        }

        function generateTXTContent(registros) {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const monthYear = `${months[reportDate.getMonth()]} ${reportDate.getFullYear()}`;
            const excelentes = registros.filter(r => r.estado_fisico === 'excelente').length;
            const optimos = registros.filter(r => r.estado_fisico === 'optimo').length;
            const malos = registros.filter(r => r.estado_fisico === 'mal_estado').length;
            const today = new Date();

            let content = `========================================\n`;
            content += `  REPORTE MENSUAL DE EXTINTORES\n`;
            content += `========================================\n\n`;
            content += `MES: ${monthYear}\n`;
            content += `FECHA DE GENERACI√ìN: ${today.toLocaleDateString('es-ES')}\n\n`;

            content += `----------------------------------------\n`;
            content += `  RESUMEN ESTAD√çSTICO\n`;
            content += `----------------------------------------\n`;
            content += `Total de extintores revisados: ${registros.length}\n`;
            content += `Estado excelente: ${excelentes}\n`;
            content += `Estado √≥ptimo: ${optimos}\n`;
            content += `Mal estado: ${malos}\n\n`;

            content += `----------------------------------------\n`;
            content += `  DETALLE DE REGISTROS\n`;
            content += `----------------------------------------\n\n`;

            registros.forEach((registro, index) => {
                content += `${index + 1}. UBICACI√ìN: ${registro.ubicacion}\n`;
                content += `   - Tipo: ${registro.tipo}\n`;
                content += `   - Capacidad: ${registro.capacidad} kg\n`;
                content += `   - Estado F√≠sico: ${registro.estado_fisico.replace('_', ' ')}\n`;
                content += `   - Man√≥metro: ${registro.manometro.replace('_', ' ')}\n`;
                content += `   - Se√±alizaci√≥n: ${registro.senalizacion ? 'S√≠' : 'No'}\n`;
                content += `   - Seguros y Cincho: ${registro.seguros ? 'S√≠' : 'No'}\n`;
                if (registro.tipo === 'PQS') {
                    content += `   - Sello de Seguridad: ${registro.selloSeguridad ? 'S√≠' : 'No'}\n`;
                }
                content += `   - Caducidad: ${registro.caducidad ? new Date(registro.caducidad + 'T00:00:00').toLocaleDateString('es-ES') : 'No especificada'}\n\n`;
            });

            content += `\n--- Fin del Reporte ---\nGenerado por ExtintorCheck Pro`;
            
            return content;
        }

        function showTXTPreview(reportText) {
            const viewer = document.getElementById('reportViewer');
            const previewArea = document.getElementById('textPreview');
            
            previewArea.value = reportText;
            viewer.style.display = 'block';
            viewer.scrollIntoView({ behavior: 'smooth' });
        }

        function copyReportText() {
            const textToCopy = document.getElementById('textPreview').value;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showAlert('üìã Texto del reporte copiado al portapapeles', 'success');
                }).catch(err => {
                    showAlert('‚ùå No se pudo copiar el texto', 'warning');
                    console.error('Error al copiar: ', err);
                });
            } else {
                // Fallback para navegadores antiguos
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showAlert('üìã Texto del reporte copiado al portapapeles', 'success');
                } catch (err) {
                    showAlert('‚ùå No se pudo copiar el texto', 'warning');
                }
                document.body.removeChild(textArea);
            }
        }

        function closeReportViewer() {
            document.getElementById('reportViewer').style.display = 'none';
            document.getElementById('textPreview').value = '';
        }
        
        // ===== NEW & MODIFIED FUNCTIONS FOR TXT REPORT END =====

        function generatePDFContent(doc, registros) {
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            let yPosition = margin;
            
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Reporte Mensual de Extintores', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;
            
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            doc.setFontSize(14);
            doc.setFont(undefined, 'normal');
            const monthYear = `${months[reportDate.getMonth()]} ${reportDate.getFullYear()}`;
            doc.text(monthYear, pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 20;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Resumen Estad√≠stico', margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            
            const excelentes = registros.filter(r => r.estado_fisico === 'excelente').length;
            const optimos = registros.filter(r => r.estado_fisico === 'optimo').length;
            const malos = registros.filter(r => r.estado_fisico === 'mal_estado').length;
            
            doc.text(`Total de extintores revisados: ${registros.length}`, margin, yPosition);
            yPosition += 7;
            doc.text(`Estado excelente: ${excelentes}`, margin, yPosition);
            yPosition += 7;
            doc.text(`Estado √≥ptimo: ${optimos}`, margin, yPosition);
            yPosition += 7;
            doc.text(`Mal estado: ${malos}`, margin, yPosition);
            yPosition += 20;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Detalle de Registros', margin, yPosition);
            yPosition += 15;
            
            registros.forEach((registro, index) => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = margin;
                }
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${index + 1}. ${registro.ubicacion}`, margin, yPosition);
                yPosition += 7;
                
                doc.setFont(undefined, 'normal');
                doc.text(`Tipo: ${registro.tipo} | Capacidad: ${registro.capacidad} kg`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`Estado f√≠sico: ${registro.estado_fisico.replace('_', ' ')}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`Man√≥metro: ${registro.manometro.replace('_', ' ')}`, margin + 5, yPosition);
                yPosition += 5;
                doc.text(`Se√±alizaci√≥n: ${registro.senalizacion ? 'S√≠' : 'No'} | Seguros: ${registro.seguros ? 'S√≠' : 'No'}`, margin + 5, yPosition);
                yPosition += 5;
                if (registro.tipo === 'PQS') {
                    doc.text(`Sello de seguridad: ${registro.selloSeguridad ? 'S√≠' : 'No'}`, margin + 5, yPosition);
                    yPosition += 5;
                }
                doc.text(`Caducidad: ${registro.caducidad ? new Date(registro.caducidad + 'T00:00:00').toLocaleDateString('es-ES') : 'No especificada'}`, margin + 5, yPosition);
                yPosition += 10;
            });
            
            const today = new Date();
            doc.setFontSize(10);
            doc.text(`Generado el ${today.toLocaleDateString('es-ES')} - ExtintorCheck Pro`, margin, doc.internal.pageSize.height - 10);
            
            return {
                title: 'Reporte Mensual de Extintores',
                monthYear: monthYear,
                totalExtintores: registros.length,
                excelentes: excelentes,
                optimos: optimos,
                malos: malos,
                registros: registros,
                generatedDate: today.toLocaleDateString('es-ES'),
                fileName: `Reporte_Extintores_${months[reportDate.getMonth()]}_${reportDate.getFullYear()}.pdf`
            };
        }

        function generatePDFURL() {
            const registros = getRegistrosByMonth(reportDate.getMonth(), reportDate.getFullYear());
            
            if (registros.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros para generar el reporte', 'warning');
                return;
            }

            showAlert('üîó Generando URL del PDF...', 'success');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pdfData = generatePDFContent(doc, registros);
                const pdfBlob = doc.output('blob');
                
                if (currentPDFURL) {
                    URL.revokeObjectURL(currentPDFURL);
                }
                
                currentPDFURL = URL.createObjectURL(pdfBlob);
                currentPDFData = pdfData;
                currentPDFBlob = pdfBlob;
                
                showPDFURLModal(currentPDFURL, pdfData.fileName);
                
            } catch (error) {
                console.error('‚ùå Error al generar URL del PDF:', error);
                showAlert('‚ùå Error al generar la URL del PDF', 'warning');
            }
        }

        function openInExternalBrowser() {
            const registros = getRegistrosByMonth(reportDate.getMonth(), reportDate.getFullYear());
            
            if (registros.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros para generar el reporte', 'warning');
                return;
            }

            showAlert('üåê Abriendo PDF en navegador externo...', 'success');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pdfData = generatePDFContent(doc, registros);
                const pdfBlob = doc.output('blob');
                
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                const newWindow = window.open(pdfUrl, '_blank', 'noopener,noreferrer');
                
                if (newWindow) {
                    showAlert('üåê PDF abierto en nueva pesta√±a', 'success');
                    
                    setTimeout(() => {
                        URL.revokeObjectURL(pdfUrl);
                    }, 30000);
                }
                
            } catch (error) {
                console.error('‚ùå Error al abrir PDF en navegador:', error);
                showAlert('‚ùå Error al abrir el PDF en navegador externo', 'warning');
            }
        }

        function showPDFURLModal(url, fileName, isBlocked = false) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; align-items: center;
                justify-content: center; z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; padding: 20px; border-radius: 12px;
                max-width: 90%; width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            modalContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #495057; margin: 0 0 10px 0;">
                        ${isBlocked ? 'üö´ Popup Bloqueado' : 'üîó URL del PDF Generada'}
                    </h3>
                    <p style="color: #6c757d; margin: 0; font-size: 14px;">
                        ${isBlocked ? 
                            'Tu navegador bloque√≥ la ventana emergente. Usa la URL de abajo:' : 
                            'URL temporal v√°lida por 30 minutos:'
                        }
                    </p>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px;">
                        <strong>Archivo:</strong> ${fileName}
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6; word-break: break-all; font-family: monospace; font-size: 11px;">
                        ${url}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="copyPDFURL('${url}')" class="btn btn-primary" style="flex: 1; padding: 8px 12px; font-size: 13px;">
                        üìã Copiar URL
                    </button>
                    <button onclick="openPDFURL('${url}')" class="btn btn-success" style="flex: 1; padding: 8px 12px; font-size: 13px;">
                        üåê Abrir
                    </button>
                    <button onclick="closePDFURLModal()" class="btn btn-secondary" style="padding: 8px 12px; font-size: 13px;">
                        ‚ùå Cerrar
                    </button>
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; font-size: 12px; color: #6c757d; text-align: center;">
                    üí° <strong>Tip:</strong> Copia la URL y p√©gala en cualquier navegador para acceder al PDF
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePDFURLModal();
                }
            });
            
            window.currentPDFModal = modal;
        }

        function copyPDFURL(url) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showAlert('üìã URL copiada al portapapeles', 'success');
                }).catch(() => {
                    fallbackCopyURL(url);
                });
            } else {
                fallbackCopyURL(url);
            }
        }

        function fallbackCopyURL(url) {
            const textArea = document.createElement('textarea');
            textArea.value = url;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showAlert('üìã URL copiada al portapapeles', 'success');
            } catch (err) {
                showAlert('‚ö†Ô∏è No se pudo copiar autom√°ticamente. Selecciona y copia manualmente.', 'warning');
            }
            
            document.body.removeChild(textArea);
        }

        function openPDFURL(url) {
            const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
            if (newWindow) {
                showAlert('üåê PDF abierto en nueva pesta√±a', 'success');
                closePDFURLModal();
            } else {
                showAlert('üö´ Popup bloqueado. Copia la URL y p√©gala manualmente en tu navegador.', 'warning');
            }
        }

        function closePDFURLModal() {
            if (window.currentPDFModal) {
                document.body.removeChild(window.currentPDFModal);
                window.currentPDFModal = null;
            }
        }

        function generatePDF() {
            const registros = getRegistrosByMonth(reportDate.getMonth(), reportDate.getFullYear());
            
            if (registros.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros para generar el reporte', 'warning');
                return;
            }

            showAlert('üìÑ Generando reporte PDF...', 'success');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pdfData = generatePDFContent(doc, registros);
                
                if (isAndroidAPK()) {
                    const pdfBlob = doc.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    
                    const tempLink = document.createElement('a');
                    tempLink.href = pdfUrl;
                    tempLink.download = pdfData.fileName;
                    tempLink.target = '_blank';
                    tempLink.rel = 'noopener noreferrer';
                    
                    try {
                        window.open(pdfUrl, '_blank', 'noopener,noreferrer');
                        
                        document.body.appendChild(tempLink);
                        tempLink.click();
                        document.body.removeChild(tempLink);
                        
                        showAlert('üì± PDF abierto en navegador para descarga', 'success');
                        
                        setTimeout(() => {
                            URL.revokeObjectURL(pdfUrl);
                        }, 10000);
                        
                    } catch (error) {
                        console.error('Error al abrir en navegador:', error);
                        doc.save(pdfData.fileName);
                        showAlert('üìÑ PDF descargado (m√©todo alternativo)', 'success');
                    }
                } else {
                    doc.save(pdfData.fileName);
                    showAlert('üìÑ Reporte PDF descargado exitosamente', 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Error al generar PDF:', error);
                showAlert('‚ùå Error al generar el PDF. Intenta nuevamente.', 'warning');
            }
        }

        function savePDFToManager() {
            const registros = getRegistrosByMonth(reportDate.getMonth(), reportDate.getFullYear());
            if (registros.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros para generar y guardar', 'warning');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pdfData = generatePDFContent(doc, registros);
            const pdfBlob = doc.output('blob');

            try {
                const reader = new FileReader();
                reader.onload = function() {
                    const base64Data = reader.result.split(',')[1];
                    
                    const savedPDF = {
                        id: Date.now(),
                        fileName: pdfData.fileName,
                        monthYear: pdfData.monthYear,
                        totalExtintores: pdfData.totalExtintores,
                        generatedDate: pdfData.generatedDate,
                        data: base64Data,
                        size: Math.round(pdfBlob.size / 1024)
                    };
                    
                    let savedPDFs = JSON.parse(localStorage.getItem('savedPDFs') || '[]');
                    
                    const existingIndex = savedPDFs.findIndex(pdf => pdf.monthYear === pdfData.monthYear);
                    if (existingIndex !== -1) {
                        if (confirm(`Ya existe un PDF para ${pdfData.monthYear}. ¬øReemplazarlo?`)) {
                            savedPDFs[existingIndex] = savedPDF;
                        } else {
                            return;
                        }
                    } else {
                        savedPDFs.push(savedPDF);
                    }
                    
                    if (savedPDFs.length > 10) {
                        savedPDFs = savedPDFs.slice(-10);
                    }
                    
                    localStorage.setItem('savedPDFs', JSON.stringify(savedPDFs));
                    updatePDFCount();
                    loadPDFList();
                    
                    showAlert('üíæ PDF guardado en el gestor exitosamente', 'success');
                };
                reader.readAsDataURL(pdfBlob);
                
            } catch (error) {
                console.error('‚ùå Error al guardar PDF:', error);
                showAlert('‚ùå Error al guardar el PDF en el gestor', 'warning');
            }
        }

        function togglePDFManager() {
            const manager = document.getElementById('pdfManager');
            if (manager.style.display === 'none') {
                manager.style.display = 'block';
                loadPDFList();
                manager.scrollIntoView({ behavior: 'smooth' });
            } else {
                manager.style.display = 'none';
            }
        }

        function updatePDFCount() {
            const savedPDFs = JSON.parse(localStorage.getItem('savedPDFs') || '[]');
            document.getElementById('pdfCount').textContent = savedPDFs.length;
        }

        function loadPDFList() {
            const savedPDFs = JSON.parse(localStorage.getItem('savedPDFs') || '[]');
            const container = document.getElementById('pdfList');
            
            if (savedPDFs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üìÑ</div>
                        <p>No hay PDFs guardados</p>
                        <p style="font-size: 12px;">Genera un PDF y gu√°rdalo para verlo aqu√≠</p>
                    </div>
                `;
                return;
            }
            
            savedPDFs.sort((a, b) => b.id - a.id);
            
            container.innerHTML = savedPDFs.map(pdf => `
                <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #495057;">${pdf.monthYear}</strong>
                        <span style="background: #17a2b8; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                            ${pdf.totalExtintores} extintores
                        </span>
                    </div>
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">
                        <div><strong>Archivo:</strong> ${pdf.fileName}</div>
                        <div><strong>Generado:</strong> ${pdf.generatedDate} | <strong>Tama√±o:</strong> ${pdf.size} KB</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;">
                        <button onclick="downloadSavedPDF(${pdf.id})" class="btn btn-success" style="padding: 6px 8px; font-size: 11px;">
                            üì• Descargar
                        </button>
                        <button onclick="deleteSavedPDF(${pdf.id})" class="btn" style="background: #dc3545; color: white; padding: 6px 8px; font-size: 11px;">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <button onclick="generateSavedPDFURL(${pdf.id})" class="btn" style="background: #6f42c1; color: white; padding: 6px 8px; font-size: 11px;">
                            üîó URL
                        </button>
                        <button onclick="openSavedPDFInBrowser(${pdf.id})" class="btn" style="background: #fd7e14; color: white; padding: 6px 8px; font-size: 11px;">
                            üåê Navegador
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function downloadSavedPDF(pdfId) {
            const savedPDFs = JSON.parse(localStorage.getItem('savedPDFs') || '[]');
            const pdf = savedPDFs.find(p => p.id === pdfId);
            
            if (!pdf) {
                showAlert('‚ö†Ô∏è PDF no encontrado', 'warning');
                return;
            }
            
            try {
                const byteCharacters = atob(pdf.data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                if (isAndroidAPK()) {
                    const pdfUrl = URL.createObjectURL(blob);
                    const tempLink = document.createElement('a');
                    tempLink.href = pdfUrl;
                    tempLink.download = pdf.fileName;
                    tempLink.target = '_blank';
                    tempLink.rel = 'noopener noreferrer';
                    
                    window.open(pdfUrl, '_blank', 'noopener,noreferrer');
                    document.body.appendChild(tempLink);
                    tempLink.click();
                    document.body.removeChild(tempLink);
                    
                    showAlert('üì± PDF abierto en navegador para descarga', 'success');
                    
                    setTimeout(() => {
                        URL.revokeObjectURL(pdfUrl);
                    }, 10000);
                } else {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = pdf.fileName;
                    a.click();
                    URL.revokeObjectURL(url);
                    showAlert('üì• PDF descargado exitosamente', 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Error al descargar PDF:', error);
                showAlert('‚ùå Error al descargar el PDF', 'warning');
            }
        }

        function deleteSavedPDF(pdfId) {
            if (!confirm('¬øEliminar este PDF del gestor?')) {
                return;
            }
            
            let savedPDFs = JSON.parse(localStorage.getItem('savedPDFs') || '[]');
            savedPDFs = savedPDFs.filter(pdf => pdf.id !== pdfId);
            localStorage.setItem('savedPDFs', JSON.stringify(savedPDFs));
            
            updatePDFCount();
            loadPDFList();
            showAlert('üóëÔ∏è PDF eliminado del gestor', 'warning');
        }

        function generateSavedPDFURL(pdfId) {
            const savedPDFs = JSON.parse(localStorage.getItem('savedPDFs') || '[]');
            const pdf = savedPDFs.find(p => p.id === pdfId);
            
            if (!pdf) {
                showAlert('‚ö†Ô∏è PDF no encontrado', 'warning');
                return;
            }
            
            try {
                const byteCharacters = atob(pdf.data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                const pdfUrl = URL.createObjectURL(blob);
                
                showPDFURLModal(pdfUrl, pdf.fileName);
                
                setTimeout(() => {
                    URL.revokeObjectURL(pdfUrl);
                }, 30 * 60 * 1000);
                
            } catch (error) {
                console.error('‚ùå Error al generar URL del PDF guardado:', error);
                showAlert('‚ùå Error al generar la URL del PDF', 'warning');
            }
        }

        function openSavedPDFInBrowser(pdfId) {
            const savedPDFs = JSON.parse(localStorage.getItem('savedPDFs') || '[]');
            const pdf = savedPDFs.find(p => p.id === pdfId);
            
            if (!pdf) {
                showAlert('‚ö†Ô∏è PDF no encontrado', 'warning');
                return;
            }
            
            try {
                const byteCharacters = atob(pdf.data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                const pdfUrl = URL.createObjectURL(blob);
                
                const newWindow = window.open(pdfUrl, '_blank', 'noopener,noreferrer');
                
                if (newWindow) {
                    showAlert('üåê PDF abierto en nueva pesta√±a', 'success');
                    
                    setTimeout(() => {
                        URL.revokeObjectURL(pdfUrl);
                    }, 30000);
                }
                
            } catch (error) {
                console.error('‚ùå Error al abrir PDF guardado en navegador:', error);
                showAlert('‚ùå Error al abrir el PDF en navegador externo', 'warning');
            }
        }

        function clearAllPDFs() {
            if (!confirm('¬øEliminar todos los PDFs guardados? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            localStorage.removeItem('savedPDFs');
            updatePDFCount();
            loadPDFList();
            showAlert('üóëÔ∏è Todos los PDFs han sido eliminados', 'warning');
        }

        // Gesti√≥n de datos
        function exportData() {
            const data = {
                registros: getRegistros(),
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `extintores_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('üì§ Datos exportados exitosamente', 'success');
        }

        function clearAllData() {
            if (confirm('¬øEst√°s seguro de eliminar todos los datos? Esta acci√≥n no se puede deshacer.')) {
                localStorage.removeItem('extintorRegistros');
                localStorage.removeItem('archivedMonths');
                loadRegistros();
                updateStats();
                showAlert('üóëÔ∏è Todos los datos han sido eliminados', 'warning');
            }
        }

        function resetMonthlyData() {
            const currentMonth = reportDate.getMonth();
            const currentYear = reportDate.getFullYear();
            
            if (!confirm(`¬øReiniciar todos los registros del mes actual? Esto eliminar√° todas las inspecciones de ${getMonthName(currentMonth)} ${currentYear}.`)) {
                return;
            }
            
            let registros = getRegistros();
            registros = registros.filter(r => !(r.mes === currentMonth && r.a√±o === currentYear));
            localStorage.setItem('extintorRegistros', JSON.stringify(registros));
            
            loadRegistros();
            updateStats();
            showAlert('üîÑ Mes actual reiniciado exitosamente', 'success');
        }

        function archiveCurrentMonth() {
            const currentMonth = reportDate.getMonth();
            const currentYear = reportDate.getFullYear();
            const registrosDelMes = getRegistrosByMonth(currentMonth, currentYear);
            
            if (registrosDelMes.length === 0) {
                showAlert('‚ö†Ô∏è No hay registros para archivar en este mes', 'warning');
                return;
            }
            
            if (!confirm(`¬øArchivar ${registrosDelMes.length} registros del mes ${getMonthName(currentMonth)} ${currentYear}?`)) {
                return;
            }
            
            let archivedMonths = JSON.parse(localStorage.getItem('archivedMonths') || '[]');
            
            const archivo = {
                mes: currentMonth,
                a√±o: currentYear,
                fechaArchivo: new Date().toISOString(),
                registros: registrosDelMes,
                totalExtintores: registrosDelMes.length,
                estadisticas: {
                    excelentes: registrosDelMes.filter(r => r.estado_fisico === 'excelente').length,
                    optimos: registrosDelMes.filter(r => r.estado_fisico === 'optimo').length,
                    malos: registrosDelMes.filter(r => r.estado_fisico === 'mal_estado').length
                }
            };
            
            const existingIndex = archivedMonths.findIndex(a => a.mes === currentMonth && a.a√±o === currentYear);
            if (existingIndex !== -1) {
                archivedMonths[existingIndex] = archivo;
            } else {
                archivedMonths.push(archivo);
            }
            
            localStorage.setItem('archivedMonths', JSON.stringify(archivedMonths));
            
            showAlert(`üì¶ Mes ${getMonthName(currentMonth)} ${currentYear} archivado exitosamente`, 'success');
        }

        function getMonthName(monthIndex) {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return months[monthIndex];
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.left = '50%';
            alertDiv.style.transform = 'translateX(-50%)';
            alertDiv.style.zIndex = '1000';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.textAlign = 'center';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>
